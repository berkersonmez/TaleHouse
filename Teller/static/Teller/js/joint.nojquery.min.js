if(function(){function t(t,e,i){for(var n=(i||0)-1,r=t?t.length:0;++n<r;)if(t[n]===e)return n;return-1}function e(e,i){var n=typeof i;if(e=e.cache,"boolean"==n||null==i)return e[i]?0:-1;"number"!=n&&"string"!=n&&(n="object");var r="number"==n?i:y+i;return e=(e=e[n])&&e[r],"object"==n?e&&t(e,i)>-1?0:-1:e?0:-1}function i(t){var e=this.cache,i=typeof t;if("boolean"==i||null==t)e[t]=!0;else{"number"!=i&&"string"!=i&&(i="object");var n="number"==i?t:y+t,r=e[i]||(e[i]={});"object"==i?(r[n]||(r[n]=[])).push(t):r[n]=!0}}function n(t){return t.charCodeAt(0)}function r(t,e){var i=t.criteria,n=e.criteria;if(i!==n){if(i>n||"undefined"==typeof i)return 1;if(n>i||"undefined"==typeof n)return-1}return t.index-e.index}function o(t){var e=-1,n=t.length,r=t[0],o=t[n/2|0],s=t[n-1];if(r&&"object"==typeof r&&o&&"object"==typeof o&&s&&"object"==typeof s)return!1;var a=h();a["false"]=a["null"]=a["true"]=a.undefined=!1;var l=h();for(l.array=t,l.cache=a,l.push=i;++e<n;)l.push(t[e]);return l}function s(t){return"\\"+Y[t]}function a(){return g.pop()||[]}function h(){return m.pop()||{array:null,cache:null,criteria:null,"false":!1,index:0,"null":!1,number:null,object:null,push:null,string:null,"true":!1,undefined:!1,value:null}}function l(){}function u(t){t.length=0,g.length<_&&g.push(t)}function c(t){var e=t.cache;e&&c(e),t.array=t.cache=t.criteria=t.object=t.number=t.string=t.value=null,m.length<_&&m.push(t)}function f(t,e,i){e||(e=0),"undefined"==typeof i&&(i=t?t.length:0);for(var n=-1,r=i-e||0,o=Array(0>r?0:r);++n<r;)o[n]=t[e+n];return o}function d(i){function g(t){return t&&"object"==typeof t&&!Jn(t)&&Cn.call(t,"__wrapped__")?t:new m(t)}function m(t,e){this.__chain__=!!e,this.__wrapped__=t}function _(t,e,i,n,r){if(i){var o=i(t);if("undefined"!=typeof o)return o}var s=Ve(t);if(!s)return t;var h=Pn.call(t);if(!U[h])return t;var l=Hn[h];switch(h){case z:case O:return new l(+t);case I:case q:return new l(t);case G:return o=l(t.source,V.exec(t)),o.lastIndex=t.lastIndex,o}var c=Jn(t);if(e){var d=!n;n||(n=a()),r||(r=a());for(var p=n.length;p--;)if(n[p]==t)return r[p];o=c?l(t.length):{}}else o=c?f(t):nr({},t);return c&&(Cn.call(t,"index")&&(o.index=t.index),Cn.call(t,"input")&&(o.input=t.input)),e?(n.push(t),r.push(o),(c?De:sr)(t,function(t,s){o[s]=_(t,e,i,n,r)}),d&&(u(n),u(r)),o):o}function Y(t,e,i){if("function"!=typeof t)return Di;if("undefined"==typeof e)return t;var n=t.__bindData__||Yn.funcNames&&!t.name;if("undefined"==typeof n){var r=P&&kn.call(t);Yn.funcNames||!r||M.test(r)||(n=!0),(Yn.funcNames||!n)&&(n=!Yn.funcDecomp||P.test(r),Wn(t,n))}if(n!==!0&&n&&1&n[1])return t;switch(i){case 1:return function(i){return t.call(e,i)};case 2:return function(i,n){return t.call(e,i,n)};case 3:return function(i,n,r){return t.call(e,i,n,r)};case 4:return function(i,n,r,o){return t.call(e,i,n,r,o)}}return Si(t,e)}function J(t,e,i,n){for(var r=(n||0)-1,o=t?t.length:0,s=[];++r<o;){var a=t[r];if(a&&"object"==typeof a&&"number"==typeof a.length&&(Jn(a)||le(a))){e||(a=J(a,e,i));var h=-1,l=a.length,u=s.length;for(s.length+=l;++h<l;)s[u++]=a[h]}else i||s.push(a)}return s}function Z(t,e,i,n,r,o){if(i){var s=i(t,e);if("undefined"!=typeof s)return!!s}if(t===e)return 0!==t||1/t==1/e;var h=typeof t,l=typeof e;if(!(t!==t||t&&H[h]||e&&H[l]))return!1;if(null==t||null==e)return t===e;var c=Pn.call(t),f=Pn.call(e);if(c==$&&(c=R),f==$&&(f=R),c!=f)return!1;switch(c){case z:case O:return+t==+e;case I:return t!=+t?e!=+e:0==t?1/t==1/e:t==+e;case G:case q:return t==pn(e)}var d=c==L;if(!d){if(Cn.call(t,"__wrapped__ ")||Cn.call(e,"__wrapped__"))return Z(t.__wrapped__||t,e.__wrapped__||e,i,n,r,o);if(c!=R)return!1;var p=t.constructor,g=e.constructor;if(p!=g&&!(Ce(p)&&p instanceof p&&Ce(g)&&g instanceof g))return!1}var m=!r;r||(r=a()),o||(o=a());for(var v=r.length;v--;)if(r[v]==t)return o[v]==e;var y=0;if(s=!0,r.push(t),o.push(e),d){if(v=t.length,y=e.length,s=y==t.length,!s&&!n)return s;for(;y--;){var x=v,_=e[y];if(n)for(;x--&&!(s=Z(t[x],_,i,n,r,o)););else if(!(s=Z(t[y],_,i,n,r,o)))break}return s}return or(e,function(e,a,h){return Cn.call(h,a)?(y++,s=Cn.call(t,a)&&Z(t[a],e,i,n,r,o)):void 0}),s&&!n&&or(t,function(t,e,i){return Cn.call(i,e)?s=--y>-1:void 0}),m&&(u(r),u(o)),s}function Q(t,e,i,n,r){(Jn(e)?De:sr)(e,function(e,o){var s,a,h=e,l=t[o];if(e&&((a=Jn(e))||ar(e))){for(var u=n.length;u--;)if(s=n[u]==e){l=r[u];break}if(!s){var c;i&&(h=i(l,e),(c="undefined"!=typeof h)&&(l=h)),c||(l=a?Jn(l)?l:[]:ar(l)?l:{}),n.push(e),r.push(l),c||Q(l,e,i,n,r)}}else i&&(h=i(l,e),"undefined"==typeof h&&(h=e)),"undefined"!=typeof h&&(l=h);t[o]=l})}function ee(i,n,r){var s=-1,h=se(),l=i?i.length:0,f=[],d=!n&&l>=x&&h===t,p=r||d?a():f;if(d){var g=o(p);g?(h=e,p=g):(d=!1,p=r?p:(u(p),f))}for(;++s<l;){var m=i[s],v=r?r(m,s,i):m;(n?!s||p[p.length-1]!==v:h(p,v)<0)&&((r||d)&&p.push(v),f.push(m))}return d?(u(p.array),c(p)):r&&u(p),f}function ie(t){return function(e,i,n){var r={};i=g.createCallback(i,n,3);var o=-1,s=e?e.length:0;if("number"==typeof s)for(;++o<s;){var a=e[o];t(r,a,i(a,o,e),e)}else sr(e,function(e,n,o){t(r,e,i(e,n,o),o)});return r}}function ne(t,e,i,n,r,o){var s=1&e,a=2&e,h=4&e,l=8&e,u=16&e,c=32&e,f=t;if(!a&&!Ce(t))throw new gn;u&&!i.length&&(e&=-17,u=i=!1),c&&!n.length&&(e&=-33,c=n=!1);var d=t&&t.__bindData__;if(d)return!s||1&d[1]||(d[4]=r),!s&&1&d[1]&&(e|=8),!h||4&d[1]||(d[5]=o),u&&Mn.apply(d[2]||(d[2]=[]),i),c&&Mn.apply(d[3]||(d[3]=[]),n),d[1]|=e,ne.apply(null,d);if(s&&!(a||h||c)&&(Yn.fastBind||Fn&&u)){if(u){var p=[r];Mn.apply(p,i)}var g=u?Fn.apply(t,p):Fn.call(t,r)}else g=function(){var d=arguments,p=s?r:this;if((h||u||c)&&(d=Un.call(d),u&&En.apply(d,i),c&&Mn.apply(d,n),h&&d.length<o))return e|=16,ne(t,l?e:-4&e,d,null,r,o);if(a&&(t=p[f]),this instanceof g){p=re(t.prototype);var m=t.apply(p,d);return Ve(m)?m:p}return t.apply(p,d)};return Wn(g,Un.call(arguments)),g}function re(t){return Ve(t)?$n(t):{}}function oe(t){return Qn[t]}function se(){var e=(e=g.indexOf)===di?t:e;return e}function ae(t){var e,i;return t&&Pn.call(t)==R&&(e=t.constructor,!Ce(e)||e instanceof e)?(or(t,function(t,e){i=e}),"undefined"==typeof i||Cn.call(t,i)):!1}function he(t){return tr[t]}function le(t){return t&&"object"==typeof t&&"number"==typeof t.length&&Pn.call(t)==$||!1}function ue(t,e,i,n){return"boolean"!=typeof e&&null!=e&&(n=i,i=e,e=!1),_(t,e,"function"==typeof i&&Y(i,n,1))}function ce(t,e,i){return _(t,!0,"function"==typeof e&&Y(e,i,1))}function fe(t,e,i){var n;return e=g.createCallback(e,i,3),sr(t,function(t,i,r){return e(t,i,r)?(n=i,!1):void 0}),n}function de(t,e,i){var n;return e=g.createCallback(e,i,3),ge(t,function(t,i,r){return e(t,i,r)?(n=i,!1):void 0}),n}function pe(t,e,i){var n=[];or(t,function(t,e){n.push(e,t)});var r=n.length;for(e=Y(e,i,3);r--&&e(n[r--],n[r],t)!==!1;);return t}function ge(t,e,i){var n=Kn(t),r=n.length;for(e=Y(e,i,3);r--;){var o=n[r];if(e(t[o],o,t)===!1)break}return t}function me(t){var e=[];return or(t,function(t,i){Ce(t)&&e.push(i)}),e.sort()}function ve(t,e){return t?Cn.call(t,e):!1}function ye(t){for(var e=-1,i=Kn(t),n=i.length,r={};++e<n;){var o=i[e];r[t[o]]=o}return r}function xe(t){return t===!0||t===!1||Pn.call(t)==z}function _e(t){return t?"object"==typeof t&&Pn.call(t)==O:!1}function be(t){return t?1===t.nodeType:!1}function we(t){var e=!0;if(!t)return e;var i=Pn.call(t),n=t.length;return i==L||i==q||i==$||i==R&&"number"==typeof n&&Ce(t.splice)?!n:(sr(t,function(){return e=!1}),e)}function ke(t,e,i,n){return Z(t,e,"function"==typeof i&&Y(i,n,2))}function je(t){return zn(t)&&!On(parseFloat(t))}function Ce(t){return"function"==typeof t}function Ve(t){return!(!t||!H[typeof t])}function Me(t){return Se(t)&&t!=+t}function Ae(t){return null===t}function Se(t){return"number"==typeof t||Pn.call(t)==I}function Te(t){return t?"object"==typeof t&&Pn.call(t)==G:!1}function Pe(t){return"string"==typeof t||Pn.call(t)==q}function Ee(t){return"undefined"==typeof t}function Be(t){var e=arguments,i=2;if(!Ve(t))return t;if("number"!=typeof e[2]&&(i=e.length),i>3&&"function"==typeof e[i-2])var n=Y(e[--i-1],e[i--],2);else i>2&&"function"==typeof e[i-1]&&(n=e[--i]);for(var r=Un.call(arguments,1,i),o=-1,s=a(),h=a();++o<i;)Q(t,r[o],n,s,h);return u(s),u(h),t}function Fe(t,e,i){var n=se(),r="function"==typeof e,o={};if(r)e=g.createCallback(e,i,3);else var s=J(arguments,!0,!1,1);return or(t,function(t,i,a){(r?!e(t,i,a):n(s,i)<0)&&(o[i]=t)}),o}function $e(t){for(var e=-1,i=Kn(t),n=i.length,r=sn(n);++e<n;){var o=i[e];r[e]=[o,t[o]]}return r}function Le(t,e,i){var n={};if("function"!=typeof e)for(var r=-1,o=J(arguments,!0,!1,1),s=Ve(t)?o.length:0;++r<s;){var a=o[r];a in t&&(n[a]=t[a])}else e=g.createCallback(e,i,3),or(t,function(t,i,r){e(t,i,r)&&(n[i]=t)});return n}function ze(t,e,i,n){var r=Jn(t);if(e=Y(e,n,4),null==i)if(r)i=[];else{var o=t&&t.constructor,s=o&&o.prototype;i=re(s)}return(r?De:sr)(t,function(t,n,r){return e(i,t,n,r)}),i}function Oe(t){for(var e=-1,i=Kn(t),n=i.length,r=sn(n);++e<n;)r[e]=t[i[e]];return r}function Ne(t){for(var e=arguments,i=-1,n=J(e,!0,!1,1),r=e[2]&&e[2][e[1]]===t?1:n.length,o=sn(r);++i<r;)o[i]=t[n[i]];return o}function Ie(t,e,i){var n=-1,r=se(),o=t?t.length:0,s=!1;return i=(0>i?In(0,o+i):i)||0,Jn(t)?s=r(t,e,i)>-1:"number"==typeof o?s=(Pe(t)?t.indexOf(e,i):r(t,e,i))>-1:sr(t,function(t){return++n>=i?!(s=t===e):void 0}),s}function Re(t,e,i){var n=!0;e=g.createCallback(e,i,3);var r=-1,o=t?t.length:0;if("number"==typeof o)for(;++r<o&&(n=!!e(t[r],r,t)););else sr(t,function(t,i,r){return n=!!e(t,i,r)});return n}function Ge(t,e,i){var n=[];e=g.createCallback(e,i,3);var r=-1,o=t?t.length:0;if("number"==typeof o)for(;++r<o;){var s=t[r];e(s,r,t)&&n.push(s)}else sr(t,function(t,i,r){e(t,i,r)&&n.push(t)});return n}function qe(t,e,i){e=g.createCallback(e,i,3);var n=-1,r=t?t.length:0;if("number"!=typeof r){var o;return sr(t,function(t,i,n){return e(t,i,n)?(o=t,!1):void 0}),o}for(;++n<r;){var s=t[n];if(e(s,n,t))return s}}function Ue(t,e,i){var n;return e=g.createCallback(e,i,3),Xe(t,function(t,i,r){return e(t,i,r)?(n=t,!1):void 0}),n}function De(t,e,i){var n=-1,r=t?t.length:0;if(e=e&&"undefined"==typeof i?e:Y(e,i,3),"number"==typeof r)for(;++n<r&&e(t[n],n,t)!==!1;);else sr(t,e);return t}function Xe(t,e,i){var n=t?t.length:0;if(e=e&&"undefined"==typeof i?e:Y(e,i,3),"number"==typeof n)for(;n--&&e(t[n],n,t)!==!1;);else{var r=Kn(t);n=r.length,sr(t,function(t,i,o){return i=r?r[--n]:--n,e(o[i],i,o)})}return t}function He(t,e){var i=Un.call(arguments,2),n=-1,r="function"==typeof e,o=t?t.length:0,s=sn("number"==typeof o?o:0);return De(t,function(t){s[++n]=(r?e:t[e]).apply(t,i)}),s}function Ye(t,e,i){var n=-1,r=t?t.length:0;if(e=g.createCallback(e,i,3),"number"==typeof r)for(var o=sn(r);++n<r;)o[n]=e(t[n],n,t);else o=[],sr(t,function(t,i,r){o[++n]=e(t,i,r)});return o}function We(t,e,i){var r=-1/0,o=r;if(!e&&Jn(t))for(var s=-1,a=t.length;++s<a;){var h=t[s];h>o&&(o=h)}else e=!e&&Pe(t)?n:g.createCallback(e,i,3),De(t,function(t,i,n){var s=e(t,i,n);s>r&&(r=s,o=t)});return o}function Je(t,e,i){var r=1/0,o=r;if(!e&&Jn(t))for(var s=-1,a=t.length;++s<a;){var h=t[s];o>h&&(o=h)}else e=!e&&Pe(t)?n:g.createCallback(e,i,3),De(t,function(t,i,n){var s=e(t,i,n);r>s&&(r=s,o=t)});return o}function Ze(t,e){var i=-1,n=t?t.length:0;if("number"==typeof n)for(var r=sn(n);++i<n;)r[i]=t[i][e];return r||Ye(t,e)}function Ke(t,e,i,n){if(!t)return i;var r=arguments.length<3;e=Y(e,n,4);var o=-1,s=t.length;if("number"==typeof s)for(r&&(i=t[++o]);++o<s;)i=e(i,t[o],o,t);else sr(t,function(t,n,o){i=r?(r=!1,t):e(i,t,n,o)});return i}function Qe(t,e,i,n){var r=arguments.length<3;return e=Y(e,n,4),Xe(t,function(t,n,o){i=r?(r=!1,t):e(i,t,n,o)}),i}function ti(t,e,i){return e=g.createCallback(e,i,3),Ge(t,function(t,i,n){return!e(t,i,n)})}function ei(t,e,i){var n=t?t.length:0;if("number"!=typeof n&&(t=Oe(t)),null==e||i)return t?t[Yi(n-1)]:p;var r=ii(t);return r.length=Rn(In(0,e),r.length),r}function ii(t){var e=-1,i=t?t.length:0,n=sn("number"==typeof i?i:0);return De(t,function(t){var i=Yi(++e);n[e]=n[i],n[i]=t}),n}function ni(t){var e=t?t.length:0;return"number"==typeof e?e:Kn(t).length}function ri(t,e,i){var n;e=g.createCallback(e,i,3);var r=-1,o=t?t.length:0;if("number"==typeof o)for(;++r<o&&!(n=e(t[r],r,t)););else sr(t,function(t,i,r){return!(n=e(t,i,r))});return!!n}function oi(t,e,i){var n=-1,o=t?t.length:0,s=sn("number"==typeof o?o:0);for(e=g.createCallback(e,i,3),De(t,function(t,i,r){var o=s[++n]=h();o.criteria=e(t,i,r),o.index=n,o.value=t}),o=s.length,s.sort(r);o--;){var a=s[o];s[o]=a.value,c(a)}return s}function si(t){return t&&"number"==typeof t.length?f(t):Oe(t)}function ai(t){for(var e=-1,i=t?t.length:0,n=[];++e<i;){var r=t[e];r&&n.push(r)}return n}function hi(i){var n=-1,r=se(),s=i?i.length:0,a=J(arguments,!0,!0,1),h=[],l=s>=x&&r===t;if(l){var u=o(a);u?(r=e,a=u):l=!1}for(;++n<s;){var f=i[n];r(a,f)<0&&h.push(f)}return l&&c(a),h}function li(t,e,i){var n=-1,r=t?t.length:0;for(e=g.createCallback(e,i,3);++n<r;)if(e(t[n],n,t))return n;return-1}function ui(t,e,i){var n=t?t.length:0;for(e=g.createCallback(e,i,3);n--;)if(e(t[n],n,t))return n;return-1}function ci(t,e,i){var n=0,r=t?t.length:0;if("number"!=typeof e&&null!=e){var o=-1;for(e=g.createCallback(e,i,3);++o<r&&e(t[o],o,t);)n++}else if(n=e,null==n||i)return t?t[0]:p;return f(t,0,Rn(In(0,n),r))}function fi(t,e,i,n){return"boolean"!=typeof e&&null!=e&&(n=i,i=n&&n[e]===t?null:e,e=!1),null!=i&&(t=Ye(t,i,n)),J(t,e)}function di(e,i,n){if("number"==typeof n){var r=e?e.length:0;n=0>n?In(0,r+n):n||0}else if(n){var o=wi(e,i);return e[o]===i?o:-1}return t(e,i,n)}function pi(t,e,i){var n=0,r=t?t.length:0;if("number"!=typeof e&&null!=e){var o=r;for(e=g.createCallback(e,i,3);o--&&e(t[o],o,t);)n++}else n=null==e||i?1:e||n;return f(t,0,Rn(In(0,r-n),r))}function gi(i){for(var n=arguments,r=n.length,s=-1,h=a(),l=-1,f=se(),d=i?i.length:0,p=[],g=a();++s<r;){var m=n[s];h[s]=f===t&&(m?m.length:0)>=x&&o(s?n[s]:g)}t:for(;++l<d;){var v=h[0];if(m=i[l],(v?e(v,m):f(g,m))<0){for(s=r,(v||g).push(m);--s;)if(v=h[s],(v?e(v,m):f(n[s],m))<0)continue t;p.push(m)}}for(;r--;)v=h[r],v&&c(v);return u(h),u(g),p}function mi(t,e,i){var n=0,r=t?t.length:0;if("number"!=typeof e&&null!=e){var o=r;for(e=g.createCallback(e,i,3);o--&&e(t[o],o,t);)n++}else if(n=e,null==n||i)return t?t[r-1]:p;return f(t,In(0,r-n))}function vi(t,e,i){var n=t?t.length:0;for("number"==typeof i&&(n=(0>i?In(0,n+i):Rn(i,n-1))+1);n--;)if(t[n]===e)return n;return-1}function yi(t){for(var e=arguments,i=0,n=e.length,r=t?t.length:0;++i<n;)for(var o=-1,s=e[i];++o<r;)t[o]===s&&(Tn.call(t,o--,1),r--);return t}function xi(t,e,i){t=+t||0,i="number"==typeof i?i:+i||1,null==e&&(e=t,t=0);for(var n=-1,r=In(0,_n((e-t)/(i||1))),o=sn(r);++n<r;)o[n]=t,t+=i;return o}function _i(t,e,i){var n=-1,r=t?t.length:0,o=[];for(e=g.createCallback(e,i,3);++n<r;){var s=t[n];e(s,n,t)&&(o.push(s),Tn.call(t,n--,1),r--)}return o}function bi(t,e,i){if("number"!=typeof e&&null!=e){var n=0,r=-1,o=t?t.length:0;for(e=g.createCallback(e,i,3);++r<o&&e(t[r],r,t);)n++}else n=null==e||i?1:In(0,e);return f(t,n)}function wi(t,e,i,n){var r=0,o=t?t.length:r;for(i=i?g.createCallback(i,n,1):Di,e=i(e);o>r;){var s=r+o>>>1;i(t[s])<e?r=s+1:o=s}return r}function ki(){return ee(J(arguments,!0,!0))}function ji(t,e,i,n){return"boolean"!=typeof e&&null!=e&&(n=i,i=n&&n[e]===t?null:e,e=!1),null!=i&&(i=g.createCallback(i,n,3)),ee(t,e,i)}function Ci(t){return hi(t,Un.call(arguments,1))}function Vi(){for(var t=arguments.length>1?arguments:arguments[0],e=-1,i=t?We(Ze(t,"length")):0,n=sn(0>i?0:i);++e<i;)n[e]=Ze(t,e);return n}function Mi(t,e){for(var i=-1,n=t?t.length:0,r={};++i<n;){var o=t[i];e?r[o]=e[i]:o&&(r[o[0]]=o[1])}return r}function Ai(t,e){if(!Ce(e))throw new gn;return function(){return--t<1?e.apply(this,arguments):void 0}}function Si(t,e){return arguments.length>2?ne(t,17,Un.call(arguments,2),null,e):ne(t,1,null,null,e)}function Ti(t){for(var e=arguments.length>1?J(arguments,!0,!1,1):me(t),i=-1,n=e.length;++i<n;){var r=e[i];t[r]=ne(t[r],1,null,null,t)}return t}function Pi(t,e){return arguments.length>2?ne(e,19,Un.call(arguments,2),null,t):ne(e,3,null,null,t)}function Ei(){for(var t=arguments,e=t.length;e--;)if(!Ce(t[e]))throw new gn;return function(){for(var e=arguments,i=t.length;i--;)e=[t[i].apply(this,e)];return e[0]}}function Bi(t,e,i){var n=typeof t;if(null==t||"function"==n)return Y(t,e,i);if("object"!=n)return function(e){return e[t]};var r=Kn(t),o=r[0],s=t[o];return 1!=r.length||s!==s||Ve(s)?function(e){for(var i=r.length,n=!1;i--&&(n=Z(e[r[i]],t[r[i]],null,!0)););return n}:function(t){var e=t[o];return s===e&&(0!==s||1/s==1/e)}}function Fi(t,e){return e="number"==typeof e?e:+e||t.length,ne(t,4,null,null,null,e)}function $i(t,e,i){var n,r,o,s,a,h,l,u=0,c=!1,f=!0;if(!Ce(t))throw new gn;if(e=In(0,e)||0,i===!0){var d=!0;f=!1}else Ve(i)&&(d=i.leading,c="maxWait"in i&&(In(e,i.maxWait)||0),f="trailing"in i?i.trailing:f);var g=function(){var i=e-(Vn()-s);if(0>=i){r&&bn(r);var c=l;r=h=l=p,c&&(u=Vn(),o=t.apply(a,n))}else h=Sn(g,i)},m=function(){h&&bn(h),r=h=l=p,(f||c!==e)&&(u=Vn(),o=t.apply(a,n))};return function(){if(n=arguments,s=Vn(),a=this,l=f&&(h||!d),c===!1)var i=d&&!h;else{r||d||(u=s);var p=c-(s-u);0>=p?(r&&(r=bn(r)),u=s,o=t.apply(a,n)):r||(r=Sn(m,p))}return h||e===c||(h=Sn(g,e)),i&&(o=t.apply(a,n)),o}}function Li(t){if(!Ce(t))throw new gn;var e=Un.call(arguments,1);return Sn(function(){t.apply(p,e)},1)}function zi(t,e){if(!Ce(t))throw new gn;var i=Un.call(arguments,2);return Sn(function(){t.apply(p,i)},e)}function Oi(t,e){if(!Ce(t))throw new gn;var i=function(){var n=i.cache,r=e?e.apply(this,arguments):y+arguments[0];return Cn.call(n,r)?n[r]:n[r]=t.apply(this,arguments)};return i.cache={},i}function Ni(t){var e,i;if(!Ce(t))throw new gn;return function(){return e?i:(e=!0,i=t.apply(this,arguments),t=null,i)}}function Ii(t){return ne(t,16,Un.call(arguments,1))}function Ri(t){return ne(t,32,null,Un.call(arguments,1))}function Gi(t,e,i){var n=!0,r=!0;if(!Ce(t))throw new gn;i===!1?n=!1:Ve(i)&&(n="leading"in i?i.leading:n,r="trailing"in i?i.trailing:r),D.leading=n,D.maxWait=e,D.trailing=r;var o=$i(t,e,D);return o}function qi(t,e){if(!Ce(e))throw new gn;return function(){var i=[t];return Mn.apply(i,arguments),e.apply(this,i)}}function Ui(t){return null==t?"":pn(t).replace(ir,oe)}function Di(t){return t}function Xi(t,e){var i=t,n=!e||Ce(i);e||(i=m,e=t,t=g),De(me(e),function(r){var o=t[r]=e[r];n&&(i.prototype[r]=function(){var e=this.__wrapped__,n=[e];Mn.apply(n,arguments);var r=o.apply(t,n);return e&&"object"==typeof e&&e===r?this:(r=new i(r),r.__chain__=this.__chain__,r)})})}function Hi(){return i._=yn,this}function Yi(t,e,i){var n=null==t,r=null==e;null==i&&("boolean"==typeof t&&r?(i=t,t=1):r||"boolean"!=typeof e||(i=e,r=!0)),n&&r&&(e=1),t=+t||0,r?(e=t,t=0):e=+e||0;var o=qn();return i||t%1||e%1?Rn(t+o*(e-t+parseFloat("1e-"+((o+"").length-1))),e):t+wn(o*(e-t+1))}function Wi(t,e){if(t){var i=t[e];return Ce(i)?t[e]():i}}function Ji(t,e,i){var n=g.templateSettings;t||(t=""),i=rr({},i,n);var r,o=rr({},i.imports,n.imports),a=Kn(o),h=Oe(o),l=0,u=i.interpolate||T,c="__p += '",f=dn((i.escape||T).source+"|"+u.source+"|"+(u===A?C:T).source+"|"+(i.evaluate||T).source+"|$","g");t.replace(f,function(e,i,n,o,a,h){return n||(n=o),c+=t.slice(l,h).replace(E,s),i&&(c+="' +\n__e("+i+") +\n'"),a&&(r=!0,c+="';\n"+a+";\n__p += '"),n&&(c+="' +\n((__t = ("+n+")) == null ? '' : __t) +\n'"),l=h+e.length,e}),c+="';\n";var d=i.variable,m=d;m||(d="obj",c="with ("+d+") {\n"+c+"\n}\n"),c=(r?c.replace(w,""):c).replace(k,"$1").replace(j,"$1;"),c="function("+d+") {\n"+(m?"":d+" || ("+d+" = {});\n")+"var __t, __p = '', __e = _.escape"+(r?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+c+"return __p\n}";var v="\n/*\n//# sourceURL="+(i.sourceURL||"/lodash/template/source["+F++ +"]")+"\n*/";try{var y=ln(a,"return "+c+v).apply(p,h)}catch(x){throw x.source=c,x}return e?y(e):(y.source=c,y)}function Zi(t,e,i){t=(t=+t)>-1?t:0;var n=-1,r=sn(t);for(e=Y(e,i,1);++n<t;)r[n]=e(n);return r}function Ki(t){return null==t?"":pn(t).replace(er,he)}function Qi(t){var e=++v;return pn(null==t?"":t)+e}function tn(t){return t=new m(t),t.__chain__=!0,t}function en(t,e){return e(t),t}function nn(){return this.__chain__=!0,this}function rn(){return pn(this.__wrapped__)}function on(){return this.__wrapped__}i=i?te.defaults(W.Object(),i,te.pick(W,B)):W;var sn=i.Array,an=i.Boolean,hn=i.Date,ln=i.Function,un=i.Math,cn=i.Number,fn=i.Object,dn=i.RegExp,pn=i.String,gn=i.TypeError,mn=[],vn=fn.prototype,yn=i._,xn=dn("^"+pn(vn.valueOf).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$"),_n=un.ceil,bn=i.clearTimeout,wn=un.floor,kn=ln.prototype.toString,jn=xn.test(jn=fn.getPrototypeOf)&&jn,Cn=vn.hasOwnProperty,Vn=xn.test(Vn=hn.now)&&Vn||function(){return+new hn},Mn=mn.push,An=i.setImmediate,Sn=i.setTimeout,Tn=mn.splice,Pn=vn.toString,En=mn.unshift,Bn=function(){try{var t={},e=xn.test(e=fn.defineProperty)&&e,i=e(t,t,t)&&e}catch(n){}return i}(),Fn=xn.test(Fn=Pn.bind)&&Fn,$n=xn.test($n=fn.create)&&$n,Ln=xn.test(Ln=sn.isArray)&&Ln,zn=i.isFinite,On=i.isNaN,Nn=xn.test(Nn=fn.keys)&&Nn,In=un.max,Rn=un.min,Gn=i.parseInt,qn=un.random,Un=mn.slice,Dn=xn.test(i.attachEvent),Xn=Fn&&!/\n|true/.test(Fn+Dn),Hn={};Hn[L]=sn,Hn[z]=an,Hn[O]=hn,Hn[N]=ln,Hn[R]=fn,Hn[I]=cn,Hn[G]=dn,Hn[q]=pn,m.prototype=g.prototype;var Yn=g.support={};Yn.fastBind=Fn&&!Xn,Yn.funcDecomp=!xn.test(i.WinRTError)&&P.test(d),Yn.funcNames="string"==typeof ln.name,g.templateSettings={escape:/<%-([\s\S]+?)%>/g,evaluate:/<%([\s\S]+?)%>/g,interpolate:A,variable:"",imports:{_:g}},$n||(re=function(t){if(Ve(t)){l.prototype=t;var e=new l;l.prototype=null}return e||{}});var Wn=Bn?function(t,e){X.value=e,Bn(t,"__bindData__",X)}:l,Jn=Ln||function(t){return t&&"object"==typeof t&&"number"==typeof t.length&&Pn.call(t)==L||!1},Zn=function(t){var e,i=t,n=[];if(!i)return n;if(!H[typeof t])return n;for(e in i)Cn.call(i,e)&&n.push(e);return n},Kn=Nn?function(t){return Ve(t)?Nn(t):[]}:Zn,Qn={"&":"&","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},tr=ye(Qn),er=dn("("+Kn(tr).join("|")+")","g"),ir=dn("["+Kn(Qn).join("")+"]","g"),nr=function(t,e,i){var n,r=t,o=r;if(!r)return o;var s=arguments,a=0,h="number"==typeof i?2:s.length;if(h>3&&"function"==typeof s[h-2])var l=Y(s[--h-1],s[h--],2);else h>2&&"function"==typeof s[h-1]&&(l=s[--h]);for(;++a<h;)if(r=s[a],r&&H[typeof r])for(var u=-1,c=H[typeof r]&&Kn(r),f=c?c.length:0;++u<f;)n=c[u],o[n]=l?l(o[n],r[n]):r[n];return o},rr=function(t,e,i){var n,r=t,o=r;if(!r)return o;for(var s=arguments,a=0,h="number"==typeof i?2:s.length;++a<h;)if(r=s[a],r&&H[typeof r])for(var l=-1,u=H[typeof r]&&Kn(r),c=u?u.length:0;++l<c;)n=u[l],"undefined"==typeof o[n]&&(o[n]=r[n]);return o},or=function(t,e,i){var n,r=t,o=r;if(!r)return o;if(!H[typeof r])return o;e=e&&"undefined"==typeof i?e:Y(e,i,3);for(n in r)if(e(r[n],n,t)===!1)return o;return o},sr=function(t,e,i){var n,r=t,o=r;if(!r)return o;if(!H[typeof r])return o;e=e&&"undefined"==typeof i?e:Y(e,i,3);for(var s=-1,a=H[typeof r]&&Kn(r),h=a?a.length:0;++s<h;)if(n=a[s],e(r[n],n,t)===!1)return o;return o},ar=function(t){if(!t||Pn.call(t)!=R)return!1;var e=t.valueOf,i="function"==typeof e&&(i=jn(e))&&jn(i);return i?t==i||jn(t)==i:ae(t)},hr=ie(function(t,e,i){Cn.call(t,i)?t[i]++:t[i]=1}),lr=ie(function(t,e,i){(Cn.call(t,i)?t[i]:t[i]=[]).push(e)}),ur=ie(function(t,e,i){t[i]=e}),cr=Ge;Xn&&K&&"function"==typeof An&&(Li=function(t){if(!Ce(t))throw new gn;return An.apply(i,arguments)});var fr=8==Gn(b+"08")?Gn:function(t,e){return Gn(Pe(t)?t.replace(S,""):t,e||0)};return g.after=Ai,g.assign=nr,g.at=Ne,g.bind=Si,g.bindAll=Ti,g.bindKey=Pi,g.chain=tn,g.compact=ai,g.compose=Ei,g.countBy=hr,g.createCallback=Bi,g.curry=Fi,g.debounce=$i,g.defaults=rr,g.defer=Li,g.delay=zi,g.difference=hi,g.filter=Ge,g.flatten=fi,g.forEach=De,g.forEachRight=Xe,g.forIn=or,g.forInRight=pe,g.forOwn=sr,g.forOwnRight=ge,g.functions=me,g.groupBy=lr,g.indexBy=ur,g.initial=pi,g.intersection=gi,g.invert=ye,g.invoke=He,g.keys=Kn,g.map=Ye,g.max=We,g.memoize=Oi,g.merge=Be,g.min=Je,g.omit=Fe,g.once=Ni,g.pairs=$e,g.partial=Ii,g.partialRight=Ri,g.pick=Le,g.pluck=Ze,g.pull=yi,g.range=xi,g.reject=ti,g.remove=_i,g.rest=bi,g.shuffle=ii,g.sortBy=oi,g.tap=en,g.throttle=Gi,g.times=Zi,g.toArray=si,g.transform=ze,g.union=ki,g.uniq=ji,g.values=Oe,g.where=cr,g.without=Ci,g.wrap=qi,g.zip=Vi,g.zipObject=Mi,g.collect=Ye,g.drop=bi,g.each=De,g.eachRight=Xe,g.extend=nr,g.methods=me,g.object=Mi,g.select=Ge,g.tail=bi,g.unique=ji,g.unzip=Vi,Xi(g),g.clone=ue,g.cloneDeep=ce,g.contains=Ie,g.escape=Ui,g.every=Re,g.find=qe,g.findIndex=li,g.findKey=fe,g.findLast=Ue,g.findLastIndex=ui,g.findLastKey=de,g.has=ve,g.identity=Di,g.indexOf=di,g.isArguments=le,g.isArray=Jn,g.isBoolean=xe,g.isDate=_e,g.isElement=be,g.isEmpty=we,g.isEqual=ke,g.isFinite=je,g.isFunction=Ce,g.isNaN=Me,g.isNull=Ae,g.isNumber=Se,g.isObject=Ve,g.isPlainObject=ar,g.isRegExp=Te,g.isString=Pe,g.isUndefined=Ee,g.lastIndexOf=vi,g.mixin=Xi,g.noConflict=Hi,g.parseInt=fr,g.random=Yi,g.reduce=Ke,g.reduceRight=Qe,g.result=Wi,g.runInContext=d,g.size=ni,g.some=ri,g.sortedIndex=wi,g.template=Ji,g.unescape=Ki,g.uniqueId=Qi,g.all=Re,g.any=ri,g.detect=qe,g.findWhere=qe,g.foldl=Ke,g.foldr=Qe,g.include=Ie,g.inject=Ke,sr(g,function(t,e){g.prototype[e]||(g.prototype[e]=function(){var e=[this.__wrapped__],i=this.__chain__;Mn.apply(e,arguments);var n=t.apply(g,e);return i?new m(n,i):n})}),g.first=ci,g.last=mi,g.sample=ei,g.take=ci,g.head=ci,sr(g,function(t,e){var i="sample"!==e;g.prototype[e]||(g.prototype[e]=function(e,n){var r=this.__chain__,o=t(this.__wrapped__,e,n);return r||null!=e&&(!n||i&&"function"==typeof e)?new m(o,r):o})}),g.VERSION="2.2.1",g.prototype.chain=nn,g.prototype.toString=rn,g.prototype.value=on,g.prototype.valueOf=on,De(["join","pop","shift"],function(t){var e=mn[t];g.prototype[t]=function(){var t=this.__chain__,i=e.apply(this.__wrapped__,arguments);return t?new m(i,t):i}}),De(["push","reverse","sort","unshift"],function(t){var e=mn[t];g.prototype[t]=function(){return e.apply(this.__wrapped__,arguments),this}}),De(["concat","slice","splice"],function(t){var e=mn[t];g.prototype[t]=function(){return new m(e.apply(this.__wrapped__,arguments),this.__chain__)}}),g}var p,g=[],m=[],v=0,y=+new Date+"",x=75,_=40,b=" 	\f \n\r\u2028\u2029 ᠎             　",w=/\b__p \+= '';/g,k=/\b(__p \+=) '' \+/g,j=/(__e\(.*?\)|\b__t\)) \+\n'';/g,C=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,V=/\w*$/,M=/^function[ \n\r\t]+\w/,A=/<%=([\s\S]+?)%>/g,S=RegExp("^["+b+"]*0+(?=.$)"),T=/($^)/,P=/\bthis\b/,E=/['\n\r\t\u2028\u2029\\]/g,B=["Array","Boolean","Date","Function","Math","Number","Object","RegExp","String","_","attachEvent","clearTimeout","isFinite","isNaN","parseInt","setImmediate","setTimeout"],F=0,$="[object Arguments]",L="[object Array]",z="[object Boolean]",O="[object Date]",N="[object Function]",I="[object Number]",R="[object Object]",G="[object RegExp]",q="[object String]",U={};U[N]=!1,U[$]=U[L]=U[z]=U[O]=U[I]=U[R]=U[G]=U[q]=!0;var D={leading:!1,maxWait:0,trailing:!1},X={configurable:!1,enumerable:!1,value:null,writable:!1},H={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1},Y={"\\":"\\","'":"'","\n":"n","\r":"r","	":"t","\u2028":"u2028","\u2029":"u2029"},W=H[typeof window]&&window||this,J=H[typeof exports]&&exports&&!exports.nodeType&&exports,Z=H[typeof module]&&module&&!module.nodeType&&module,K=Z&&Z.exports===J&&J,Q=H[typeof global]&&global;!Q||Q.global!==Q&&Q.window!==Q||(W=Q);var te=d();"function"==typeof define&&"object"==typeof define.amd&&define.amd?(W._=te,define(function(){return te})):J&&Z?K?(Z.exports=te)._=te:J._=te:W._=te}.call(this),function(t,e){if("function"==typeof define&&define.amd)define(["underscore","jquery","exports"],function(i,n,r){t.Backbone=e(t,r,i,n)});else if("undefined"!=typeof exports){var i=require("underscore");e(t,exports,i)}else t.Backbone=e(t,{},t._,t.jQuery||t.Zepto||t.ender||t.$)}(this,function(t,e,i,n){var r=t.Backbone,o=[],s=(o.push,o.slice);o.splice,e.VERSION="1.1.2",e.$=n,e.noConflict=function(){return t.Backbone=r,this},e.emulateHTTP=!1,e.emulateJSON=!1;var a=e.Events={on:function(t,e,i){if(!l(this,"on",t,[e,i])||!e)return this;this._events||(this._events={});var n=this._events[t]||(this._events[t]=[]);return n.push({callback:e,context:i,ctx:i||this}),this},once:function(t,e,n){if(!l(this,"once",t,[e,n])||!e)return this;var r=this,o=i.once(function(){r.off(t,o),e.apply(this,arguments)});return o._callback=e,this.on(t,o,n)},off:function(t,e,n){var r,o,s,a,h,u,c,f;if(!this._events||!l(this,"off",t,[e,n]))return this;if(!t&&!e&&!n)return this._events=void 0,this;for(a=t?[t]:i.keys(this._events),h=0,u=a.length;u>h;h++)if(t=a[h],s=this._events[t]){if(this._events[t]=r=[],e||n)for(c=0,f=s.length;f>c;c++)o=s[c],(e&&e!==o.callback&&e!==o.callback._callback||n&&n!==o.context)&&r.push(o);r.length||delete this._events[t]}return this},trigger:function(t){if(!this._events)return this;var e=s.call(arguments,1);if(!l(this,"trigger",t,e))return this;var i=this._events[t],n=this._events.all;return i&&u(i,e),n&&u(n,arguments),this},stopListening:function(t,e,n){var r=this._listeningTo;if(!r)return this;var o=!e&&!n;n||"object"!=typeof e||(n=this),t&&((r={})[t._listenId]=t);for(var s in r)t=r[s],t.off(e,n,this),(o||i.isEmpty(t._events))&&delete this._listeningTo[s];return this}},h=/\s+/,l=function(t,e,i,n){if(!i)return!0;if("object"==typeof i){for(var r in i)t[e].apply(t,[r,i[r]].concat(n));return!1}if(h.test(i)){for(var o=i.split(h),s=0,a=o.length;a>s;s++)t[e].apply(t,[o[s]].concat(n));return!1}return!0},u=function(t,e){var i,n=-1,r=t.length,o=e[0],s=e[1],a=e[2];switch(e.length){case 0:for(;++n<r;)(i=t[n]).callback.call(i.ctx);return;case 1:for(;++n<r;)(i=t[n]).callback.call(i.ctx,o);return;case 2:for(;++n<r;)(i=t[n]).callback.call(i.ctx,o,s);return;case 3:for(;++n<r;)(i=t[n]).callback.call(i.ctx,o,s,a);return;default:for(;++n<r;)(i=t[n]).callback.apply(i.ctx,e);return}},c={listenTo:"on",listenToOnce:"once"};i.each(c,function(t,e){a[e]=function(e,n,r){var o=this._listeningTo||(this._listeningTo={}),s=e._listenId||(e._listenId=i.uniqueId("l"));return o[s]=e,r||"object"!=typeof n||(r=this),e[t](n,r,this),this}}),a.bind=a.on,a.unbind=a.off,i.extend(e,a);var f=e.Model=function(t,e){var n=t||{};e||(e={}),this.cid=i.uniqueId("c"),this.attributes={},e.collection&&(this.collection=e.collection),e.parse&&(n=this.parse(n,e)||{}),n=i.defaults({},n,i.result(this,"defaults")),this.set(n,e),this.changed={},this.initialize.apply(this,arguments)};i.extend(f.prototype,a,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(){return i.clone(this.attributes)},sync:function(){return e.sync.apply(this,arguments)},get:function(t){return this.attributes[t]},escape:function(t){return i.escape(this.get(t))},has:function(t){return null!=this.get(t)},set:function(t,e,n){var r,o,s,a,h,l,u,c;if(null==t)return this;if("object"==typeof t?(o=t,n=e):(o={})[t]=e,n||(n={}),!this._validate(o,n))return!1;s=n.unset,h=n.silent,a=[],l=this._changing,this._changing=!0,l||(this._previousAttributes=i.clone(this.attributes),this.changed={}),c=this.attributes,u=this._previousAttributes,this.idAttribute in o&&(this.id=o[this.idAttribute]);for(r in o)e=o[r],i.isEqual(c[r],e)||a.push(r),i.isEqual(u[r],e)?delete this.changed[r]:this.changed[r]=e,s?delete c[r]:c[r]=e;if(!h){a.length&&(this._pending=n);for(var f=0,d=a.length;d>f;f++)this.trigger("change:"+a[f],this,c[a[f]],n)}if(l)return this;if(!h)for(;this._pending;)n=this._pending,this._pending=!1,this.trigger("change",this,n);return this._pending=!1,this._changing=!1,this},unset:function(t,e){return this.set(t,void 0,i.extend({},e,{unset:!0}))},clear:function(t){var e={};for(var n in this.attributes)e[n]=void 0;return this.set(e,i.extend({},t,{unset:!0}))},hasChanged:function(t){return null==t?!i.isEmpty(this.changed):i.has(this.changed,t)},changedAttributes:function(t){if(!t)return this.hasChanged()?i.clone(this.changed):!1;var e,n=!1,r=this._changing?this._previousAttributes:this.attributes;for(var o in t)i.isEqual(r[o],e=t[o])||((n||(n={}))[o]=e);return n},previous:function(t){return null!=t&&this._previousAttributes?this._previousAttributes[t]:null
},previousAttributes:function(){return i.clone(this._previousAttributes)},fetch:function(t){t=t?i.clone(t):{},void 0===t.parse&&(t.parse=!0);var e=this,n=t.success;return t.success=function(i){return e.set(e.parse(i,t),t)?(n&&n(e,i,t),void e.trigger("sync",e,i,t)):!1},z(this,t),this.sync("read",this,t)},save:function(t,e,n){var r,o,s,a=this.attributes;if(null==t||"object"==typeof t?(r=t,n=e):(r={})[t]=e,n=i.extend({validate:!0},n),r&&!n.wait){if(!this.set(r,n))return!1}else if(!this._validate(r,n))return!1;r&&n.wait&&(this.attributes=i.extend({},a,r)),void 0===n.parse&&(n.parse=!0);var h=this,l=n.success;return n.success=function(t){h.attributes=a;var e=h.parse(t,n);return n.wait&&(e=i.extend(r||{},e)),i.isObject(e)&&!h.set(e,n)?!1:(l&&l(h,t,n),void h.trigger("sync",h,t,n))},z(this,n),o=this.isNew()?"create":n.patch?"patch":"update","patch"===o&&(n.attrs=r),s=this.sync(o,this,n),r&&n.wait&&(this.attributes=a),s},destroy:function(t){t=t?i.clone(t):{};var e=this,n=t.success,r=function(){e.trigger("destroy",e,e.collection,t)};if(t.success=function(i){(t.wait||e.isNew())&&r(),n&&n(e,i,t),e.isNew()||e.trigger("sync",e,i,t)},this.isNew())return t.success(),!1;z(this,t);var o=this.sync("delete",this,t);return t.wait||r(),o},url:function(){var t=i.result(this,"urlRoot")||i.result(this.collection,"url")||L();return this.isNew()?t:t.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},parse:function(t){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(t){return this._validate({},i.extend(t||{},{validate:!0}))},_validate:function(t,e){if(!e.validate||!this.validate)return!0;t=i.extend({},this.attributes,t);var n=this.validationError=this.validate(t,e)||null;return n?(this.trigger("invalid",this,n,i.extend(e,{validationError:n})),!1):!0}});var d=["keys","values","pairs","invert","pick","omit"];i.each(d,function(t){f.prototype[t]=function(){var e=s.call(arguments);return e.unshift(this.attributes),i[t].apply(i,e)}});var p=e.Collection=function(t,e){e||(e={}),e.model&&(this.model=e.model),void 0!==e.comparator&&(this.comparator=e.comparator),this._reset(),this.initialize.apply(this,arguments),t&&this.reset(t,i.extend({silent:!0},e))},g={add:!0,remove:!0,merge:!0},m={add:!0,remove:!1};i.extend(p.prototype,a,{model:f,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return e.sync.apply(this,arguments)},add:function(t,e){return this.set(t,i.extend({merge:!1},e,m))},remove:function(t,e){var n=!i.isArray(t);t=n?[t]:i.clone(t),e||(e={});var r,o,s,a;for(r=0,o=t.length;o>r;r++)a=t[r]=this.get(t[r]),a&&(delete this._byId[a.id],delete this._byId[a.cid],s=this.indexOf(a),this.models.splice(s,1),this.length--,e.silent||(e.index=s,a.trigger("remove",a,this,e)),this._removeReference(a,e));return n?t[0]:t},set:function(t,e){e=i.defaults({},e,g),e.parse&&(t=this.parse(t,e));var n=!i.isArray(t);t=n?t?[t]:[]:i.clone(t);var r,o,s,a,h,l,u,c=e.at,d=this.model,p=this.comparator&&null==c&&e.sort!==!1,m=i.isString(this.comparator)?this.comparator:null,v=[],y=[],x={},_=e.add,b=e.merge,w=e.remove,k=!p&&_&&w?[]:!1;for(r=0,o=t.length;o>r;r++){if(h=t[r]||{},s=h instanceof f?a=h:h[d.prototype.idAttribute||"id"],l=this.get(s))w&&(x[l.cid]=!0),b&&(h=h===a?a.attributes:h,e.parse&&(h=l.parse(h,e)),l.set(h,e),p&&!u&&l.hasChanged(m)&&(u=!0)),t[r]=l;else if(_){if(a=t[r]=this._prepareModel(h,e),!a)continue;v.push(a),this._addReference(a,e)}a=l||a,!k||!a.isNew()&&x[a.id]||k.push(a),x[a.id]=!0}if(w){for(r=0,o=this.length;o>r;++r)x[(a=this.models[r]).cid]||y.push(a);y.length&&this.remove(y,e)}if(v.length||k&&k.length)if(p&&(u=!0),this.length+=v.length,null!=c)for(r=0,o=v.length;o>r;r++)this.models.splice(c+r,0,v[r]);else{k&&(this.models.length=0);var j=k||v;for(r=0,o=j.length;o>r;r++)this.models.push(j[r])}if(u&&this.sort({silent:!0}),!e.silent){for(r=0,o=v.length;o>r;r++)(a=v[r]).trigger("add",a,this,e);(u||k&&k.length)&&this.trigger("sort",this,e)}return n?t[0]:t},reset:function(t,e){e||(e={});for(var n=0,r=this.models.length;r>n;n++)this._removeReference(this.models[n],e);return e.previousModels=this.models,this._reset(),t=this.add(t,i.extend({silent:!0},e)),e.silent||this.trigger("reset",this,e),t},push:function(t,e){return this.add(t,i.extend({at:this.length},e))},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t),e},unshift:function(t,e){return this.add(t,i.extend({at:0},e))},shift:function(t){var e=this.at(0);return this.remove(e,t),e},slice:function(){return s.apply(this.models,arguments)},get:function(t){return null==t?void 0:this._byId[t]||this._byId[t.id]||this._byId[t.cid]},at:function(t){return this.models[t]},where:function(t,e){return i.isEmpty(t)?e?void 0:[]:this[e?"find":"filter"](function(e){for(var i in t)if(t[i]!==e.get(i))return!1;return!0})},findWhere:function(t){return this.where(t,!0)},sort:function(t){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return t||(t={}),i.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(i.bind(this.comparator,this)),t.silent||this.trigger("sort",this,t),this},pluck:function(t){return i.invoke(this.models,"get",t)},fetch:function(t){t=t?i.clone(t):{},void 0===t.parse&&(t.parse=!0);var e=t.success,n=this;return t.success=function(i){var r=t.reset?"reset":"set";n[r](i,t),e&&e(n,i,t),n.trigger("sync",n,i,t)},z(this,t),this.sync("read",this,t)},create:function(t,e){if(e=e?i.clone(e):{},!(t=this._prepareModel(t,e)))return!1;e.wait||this.add(t,e);var n=this,r=e.success;return e.success=function(t,i){e.wait&&n.add(t,e),r&&r(t,i,e)},t.save(null,e),t},parse:function(t){return t},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(t,e){if(t instanceof f)return t;e=e?i.clone(e):{},e.collection=this;var n=new this.model(t,e);return n.validationError?(this.trigger("invalid",this,n.validationError,e),!1):n},_addReference:function(t){this._byId[t.cid]=t,null!=t.id&&(this._byId[t.id]=t),t.collection||(t.collection=this),t.on("all",this._onModelEvent,this)},_removeReference:function(t){this===t.collection&&delete t.collection,t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,i,n){("add"!==t&&"remove"!==t||i===this)&&("destroy"===t&&this.remove(e,n),e&&t==="change:"+e.idAttribute&&(delete this._byId[e.previous(e.idAttribute)],null!=e.id&&(this._byId[e.id]=e)),this.trigger.apply(this,arguments))}});var v=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain","sample"];i.each(v,function(t){p.prototype[t]=function(){var e=s.call(arguments);return e.unshift(this.models),i[t].apply(i,e)}});var y=["groupBy","countBy","sortBy","indexBy"];i.each(y,function(t){p.prototype[t]=function(e,n){var r=i.isFunction(e)?e:function(t){return t.get(e)};return i[t](this.models,r,n)}});var x=e.View=function(t){this.cid=i.uniqueId("view"),t||(t={}),i.extend(this,i.pick(t,b)),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},_=/^(\S+)\s*(.*)$/,b=["model","collection","el","id","attributes","className","tagName","events"];i.extend(x.prototype,a,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(t,i){return this.$el&&this.undelegateEvents(),this.$el=t instanceof e.$?t:e.$(t),this.el=this.$el[0],i!==!1&&this.delegateEvents(),this},delegateEvents:function(t){if(!t&&!(t=i.result(this,"events")))return this;this.undelegateEvents();for(var e in t){var n=t[e];if(i.isFunction(n)||(n=this[t[e]]),n){var r=e.match(_),o=r[1],s=r[2];n=i.bind(n,this),o+=".delegateEvents"+this.cid,""===s?this.$el.on(o,n):this.$el.on(o,s,n)}}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_ensureElement:function(){if(this.el)this.setElement(i.result(this,"el"),!1);else{var t=i.extend({},i.result(this,"attributes"));this.id&&(t.id=i.result(this,"id")),this.className&&(t["class"]=i.result(this,"className"));var n=e.$("<"+i.result(this,"tagName")+">").attr(t);this.setElement(n,!1)}}}),e.sync=function(t,n,r){var o=k[t];i.defaults(r||(r={}),{emulateHTTP:e.emulateHTTP,emulateJSON:e.emulateJSON});var s={type:o,dataType:"json"};if(r.url||(s.url=i.result(n,"url")||L()),null!=r.data||!n||"create"!==t&&"update"!==t&&"patch"!==t||(s.contentType="application/json",s.data=JSON.stringify(r.attrs||n.toJSON(r))),r.emulateJSON&&(s.contentType="application/x-www-form-urlencoded",s.data=s.data?{model:s.data}:{}),r.emulateHTTP&&("PUT"===o||"DELETE"===o||"PATCH"===o)){s.type="POST",r.emulateJSON&&(s.data._method=o);var a=r.beforeSend;r.beforeSend=function(t){return t.setRequestHeader("X-HTTP-Method-Override",o),a?a.apply(this,arguments):void 0}}"GET"===s.type||r.emulateJSON||(s.processData=!1),"PATCH"===s.type&&w&&(s.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var h=r.xhr=e.ajax(i.extend(s,r));return n.trigger("request",n,h,r),h};var w=!("undefined"==typeof window||!window.ActiveXObject||window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent),k={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};e.ajax=function(){return e.$.ajax.apply(e.$,arguments)};var j=e.Router=function(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},C=/\((.*?)\)/g,V=/(\(\?)?:\w+/g,M=/\*\w+/g,A=/[\-{}\[\]+?.,\\\^$|#\s]/g;i.extend(j.prototype,a,{initialize:function(){},route:function(t,n,r){i.isRegExp(t)||(t=this._routeToRegExp(t)),i.isFunction(n)&&(r=n,n=""),r||(r=this[n]);var o=this;return e.history.route(t,function(i){var s=o._extractParameters(t,i);o.execute(r,s),o.trigger.apply(o,["route:"+n].concat(s)),o.trigger("route",n,s),e.history.trigger("route",o,n,s)}),this},execute:function(t,e){t&&t.apply(this,e)},navigate:function(t,i){return e.history.navigate(t,i),this},_bindRoutes:function(){if(this.routes){this.routes=i.result(this,"routes");for(var t,e=i.keys(this.routes);null!=(t=e.pop());)this.route(t,this.routes[t])}},_routeToRegExp:function(t){return t=t.replace(A,"\\$&").replace(C,"(?:$1)?").replace(V,function(t,e){return e?t:"([^/?]+)"}).replace(M,"([^?]*?)"),new RegExp("^"+t+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(t,e){var n=t.exec(e).slice(1);return i.map(n,function(t,e){return e===n.length-1?t||null:t?decodeURIComponent(t):null})}});var S=e.History=function(){this.handlers=[],i.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},T=/^[#\/]|\s+$/g,P=/^\/+|\/+$/g,E=/msie [\w.]+/,B=/\/$/,F=/#.*$/;S.started=!1,i.extend(S.prototype,a,{interval:50,atRoot:function(){return this.location.pathname.replace(/[^\/]$/,"$&/")===this.root},getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getFragment:function(t,e){if(null==t)if(this._hasPushState||!this._wantsHashChange||e){t=decodeURI(this.location.pathname+this.location.search);var i=this.root.replace(B,"");t.indexOf(i)||(t=t.slice(i.length))}else t=this.getHash();return t.replace(T,"")},start:function(t){if(S.started)throw new Error("Backbone.history has already been started");S.started=!0,this.options=i.extend({root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var n=this.getFragment(),r=document.documentMode,o=E.exec(navigator.userAgent.toLowerCase())&&(!r||7>=r);if(this.root=("/"+this.root+"/").replace(P,"/"),o&&this._wantsHashChange){var s=e.$('<iframe src="javascript:0" tabindex="-1">');this.iframe=s.hide().appendTo("body")[0].contentWindow,this.navigate(n)}this._hasPushState?e.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!o?e.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=n;var a=this.location;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot())return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+"#"+this.fragment),!0;this._hasPushState&&this.atRoot()&&a.hash&&(this.fragment=this.getHash().replace(T,""),this.history.replaceState({},document.title,this.root+this.fragment))}return this.options.silent?void 0:this.loadUrl()},stop:function(){e.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),this._checkUrlInterval&&clearInterval(this._checkUrlInterval),S.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(){var t=this.getFragment();return t===this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe))),t===this.fragment?!1:(this.iframe&&this.navigate(t),void this.loadUrl())},loadUrl:function(t){return t=this.fragment=this.getFragment(t),i.any(this.handlers,function(e){return e.route.test(t)?(e.callback(t),!0):void 0})},navigate:function(t,e){if(!S.started)return!1;e&&e!==!0||(e={trigger:!!e});var i=this.root+(t=this.getFragment(t||""));if(t=t.replace(F,""),this.fragment!==t){if(this.fragment=t,""===t&&"/"!==i&&(i=i.slice(0,-1)),this._hasPushState)this.history[e.replace?"replaceState":"pushState"]({},document.title,i);else{if(!this._wantsHashChange)return this.location.assign(i);this._updateHash(this.location,t,e.replace),this.iframe&&t!==this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,t,e.replace))}return e.trigger?this.loadUrl(t):void 0}},_updateHash:function(t,e,i){if(i){var n=t.href.replace(/(javascript:|#).*$/,"");t.replace(n+"#"+e)}else t.hash="#"+e}}),e.history=new S;var $=function(t,e){var n,r=this;n=t&&i.has(t,"constructor")?t.constructor:function(){return r.apply(this,arguments)},i.extend(n,r,e);var o=function(){this.constructor=n};return o.prototype=r.prototype,n.prototype=new o,t&&i.extend(n.prototype,t),n.__super__=r.prototype,n};f.extend=p.extend=j.extend=x.extend=S.extend=$;var L=function(){throw new Error('A "url" property or function must be specified')},z=function(t,e){var i=e.error;e.error=function(n){i&&i(t,n,e),t.trigger("error",t,n,e)}};return e}),function(t,e){"function"==typeof define&&define.amd?define([],e):t.Vectorizer=t.V=e()}(this,function(){function t(){var t=++c+"";return"v-"+t}function e(t){var e='<svg xmlns="'+l.xmlns+'" xmlns:xlink="'+l.xlink+'" version="'+u+'">'+(t||"")+"</svg>",i=new DOMParser;return i.async=!1,i.parseFromString(e,"text/xml").documentElement}function i(t,i,r){if(!t)return void 0;if("object"==typeof t)return new a(t);if(i=i||{},"svg"===t.toLowerCase())return new a(e());if("<"===t[0]){var o=e(t);if(o.childNodes.length>1){for(var s=[],h=0,u=o.childNodes.length;u>h;h++){var c=o.childNodes[h];s.push(new a(document.importNode(c,!0)))}return s}return new a(document.importNode(o.firstChild,!0))}t=document.createElementNS(l.xmlns,t);for(var f in i)n(t,f,i[f]);"[object Array]"!=Object.prototype.toString.call(r)&&(r=[r]);for(var d,h=0,u=r[0]&&r.length||0;u>h;h++)d=r[h],t.appendChild(d instanceof a?d.node:d);return new a(t)}function n(t,e,i){if(e.indexOf(":")>-1){var n=e.split(":");t.setAttributeNS(l[n[0]],n[1],i)}else"id"===e?t.id=i:t.setAttribute(e,i)}function r(t){var e,i,n;if(t){var r=/[ ,]+/,o=t.match(/translate\((.*)\)/);o&&(e=o[1].split(r));var s=t.match(/rotate\((.*)\)/);s&&(i=s[1].split(r));var a=t.match(/scale\((.*)\)/);a&&(n=a[1].split(r))}var h=n&&n[0]?parseFloat(n[0]):1;return{translate:{tx:e&&e[0]?parseInt(e[0],10):0,ty:e&&e[1]?parseInt(e[1],10):0},rotate:{angle:i&&i[0]?parseInt(i[0],10):0,cx:i&&i[1]?parseInt(i[1],10):void 0,cy:i&&i[2]?parseInt(i[2],10):void 0},scale:{sx:h,sy:n&&n[1]?parseFloat(n[1]):h}}}function o(t,e){var i=e.x*t.a+e.y*t.c+0,n=e.x*t.b+e.y*t.d+0;return{x:i,y:n}}function s(t){var e=o(t,{x:0,y:1}),i=o(t,{x:1,y:0}),n=180/Math.PI*Math.atan2(e.y,e.x)-90,r=180/Math.PI*Math.atan2(i.y,i.x);return{translateX:t.e,translateY:t.f,scaleX:Math.sqrt(t.a*t.a+t.b*t.b),scaleY:Math.sqrt(t.c*t.c+t.d*t.d),skewX:n,skewY:r,rotation:n}}function a(e){this.node=e,this.node.id||(this.node.id=t())}function h(t){var e=t.rx||t["top-rx"]||0,i=t.rx||t["bottom-rx"]||0,n=t.ry||t["top-ry"]||0,r=t.ry||t["bottom-ry"]||0;return["M",t.x,t.y+n,"v",t.height-n-r,"a",i,r,0,0,0,i,r,"h",t.width-2*i,"a",i,r,0,0,0,i,-r,"v",-(t.height-r-n),"a",e,n,0,0,0,-e,-n,"h",-(t.width-2*e),"a",e,n,0,0,0,-e,n].join(" ")}var l=(!(!window.SVGAngle&&!document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")),{xmlns:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink"}),u="1.1",c=0;a.prototype={translate:function(t,e,i){i=i||{},e=e||0;var n=this.attr("transform")||"",o=r(n);if("undefined"==typeof t)return o.translate;n=n.replace(/translate\([^\)]*\)/g,"").trim();var s=i.absolute?t:o.translate.tx+t,a=i.absolute?e:o.translate.ty+e,h="translate("+s+","+a+")";return this.attr("transform",(h+" "+n).trim()),this},rotate:function(t,e,i,n){n=n||{};var o=this.attr("transform")||"",s=r(o);if("undefined"==typeof t)return s.rotate;o=o.replace(/rotate\([^\)]*\)/g,"").trim(),t%=360;var a=n.absolute?t:s.rotate.angle+t,h=void 0!==e&&void 0!==i?","+e+","+i:"",l="rotate("+a+h+")";return this.attr("transform",(o+" "+l).trim()),this},scale:function(t,e){e="undefined"==typeof e?t:e;var i=this.attr("transform")||"",n=r(i);if("undefined"==typeof t)return n.scale;i=i.replace(/scale\([^\)]*\)/g,"").trim();var o="scale("+t+","+e+")";return this.attr("transform",(i+" "+o).trim()),this},bbox:function(t,e){if(!this.node.ownerSVGElement)return{x:0,y:0,width:0,height:0};var i;try{i=this.node.getBBox(),i={x:0|i.x,y:0|i.y,width:0|i.width,height:0|i.height}}catch(n){i={x:this.node.clientLeft,y:this.node.clientTop,width:this.node.clientWidth,height:this.node.clientHeight}}if(t)return i;var r=this.node.getTransformToElement(e||this.node.ownerSVGElement),o=[],s=this.node.ownerSVGElement.createSVGPoint();s.x=i.x,s.y=i.y,o.push(s.matrixTransform(r)),s.x=i.x+i.width,s.y=i.y,o.push(s.matrixTransform(r)),s.x=i.x+i.width,s.y=i.y+i.height,o.push(s.matrixTransform(r)),s.x=i.x,s.y=i.y+i.height,o.push(s.matrixTransform(r));for(var a=o[0].x,h=a,l=o[0].y,u=l,c=1,f=o.length;f>c;c++){var d=o[c].x,p=o[c].y;a>d?a=d:d>h&&(h=d),l>p?l=p:p>u&&(u=p)}return{x:a,y:l,width:h-a,height:u-l}},text:function(t,e){e=e||{};var i,n=t.split("\n"),r=0;if(this.attr("y","0.8em"),this.attr("display",t?null:"none"),this.node.setAttributeNS("http://www.w3.org/XML/1998/namespace","xml:space","preserve"),1===n.length)return this.node.textContent=t,this;for(this.node.textContent="";r<n.length;r++)i=f("tspan",{dy:0==r?"0em":e.lineHeight||"1em",x:this.attr("x")||0}),i.node.textContent=n[r]||" ",this.append(i);return this},attr:function(t,e){if("string"==typeof t&&"undefined"==typeof e)return this.node.getAttribute(t);if("object"==typeof t)for(var i in t)t.hasOwnProperty(i)&&n(this.node,i,t[i]);else n(this.node,t,e);return this},remove:function(){this.node.parentNode&&this.node.parentNode.removeChild(this.node)},append:function(t){var e=t;"[object Array]"!==Object.prototype.toString.call(t)&&(e=[t]);for(var i=0,n=e.length;n>i;i++)t=e[i],this.node.appendChild(t instanceof a?t.node:t);return this},prepend:function(t){this.node.insertBefore(t instanceof a?t.node:t,this.node.firstChild)},svg:function(){return this.node instanceof window.SVGSVGElement?this:f(this.node.ownerSVGElement)},defs:function(){var t=this.svg().node.getElementsByTagName("defs");return t&&t.length?f(t[0]):void 0},clone:function(){var e=f(this.node.cloneNode(!0));return e.node.id=t(),e},findOne:function(t){var e=this.node.querySelector(t);return e?f(e):void 0},find:function(t){for(var e=this.node.querySelectorAll(t),i=0,n=e.length;n>i;i++)e[i]=f(e[i]);return e},toLocalPoint:function(t,e){var i=this.svg().node,n=i.createSVGPoint();n.x=t,n.y=e;try{var r=n.matrixTransform(i.getScreenCTM().inverse()),o=this.node.getTransformToElement(i).inverse()}catch(s){return n}return r.matrixTransform(o)},translateCenterToPoint:function(t){var e=this.bbox(),i=g.rect(e).center();this.translate(t.x-i.x,t.y-i.y)},translateAndAutoOrient:function(t,e,i){var n=this.scale();this.attr("transform",""),this.scale(n.sx,n.sy);var r=this.svg().node,o=this.bbox(!1,i),a=r.createSVGTransform();a.setTranslate(-o.x-o.width/2,-o.y-o.height/2);var h=r.createSVGTransform(),l=g.point(t).changeInAngle(t.x-e.x,t.y-e.y,e);h.setRotate(l,0,0);var u=r.createSVGTransform(),c=g.point(t).move(e,o.width/2);u.setTranslate(t.x+(t.x-c.x),t.y+(t.y-c.y));var f=this.node.getTransformToElement(i),d=r.createSVGTransform();d.setMatrix(u.matrix.multiply(h.matrix.multiply(a.matrix.multiply(f))));var p=s(d.matrix);return this.translate(p.translateX,p.translateY),this.rotate(p.rotation),this},animateAlongPath:function(t,e){var i=f("animateMotion",t),n=f("mpath",{"xlink:href":"#"+f(e).node.id});i.append(n),this.append(i);try{i.node.beginElement()}catch(r){if("fake"===document.documentElement.getAttribute("smiling")){var o=i.node;o.animators=[];var s=o.getAttribute("id");s&&(id2anim[s]=o);for(var a=getTargets(o),h=0,l=a.length;l>h;h++){var u=a[h],c=new Animator(o,u,h);animators.push(c),o.animators[h]=c,c.register()}}}},hasClass:function(t){return new RegExp("(\\s|^)"+t+"(\\s|$)").test(this.node.getAttribute("class"))},addClass:function(t){if(!this.hasClass(t)){var e=this.node.getAttribute("class")||"";this.node.setAttribute("class",(e+" "+t).trim())}return this},removeClass:function(t){if(this.hasClass(t)){var e=this.node.getAttribute("class").replace(new RegExp("(\\s|^)"+t+"(\\s|$)","g"),"$2");this.node.setAttribute("class",e)}return this},toggleClass:function(t,e){var i="undefined"==typeof e?this.hasClass(t):!e;return i?this.removeClass(t):this.addClass(t),this}};var f=i;f.decomposeMatrix=s,f.rectToPath=h;var d=f("svg").node;return f.createSVGMatrix=function(t){var e=d.createSVGMatrix();for(var i in t)e[i]=t[i];return e},f.createSVGTransform=function(){return d.createSVGTransform()},f.createSVGPoint=function(t,e){var i=d.createSVGPoint();return i.x=t,i.y=e,i},f}),function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.g=e()}(this,function(){function t(e,i){if(!(this instanceof t))return new t(e,i);var n;void 0===i&&Object(e)!==e?(n=e.split(-1===e.indexOf("@")?" ":"@"),this.x=parseInt(n[0],10),this.y=parseInt(n[1],10)):Object(e)===e?(this.x=e.x,this.y=e.y):(this.x=e,this.y=i)}function e(i,n){return this instanceof e?(this.start=t(i),void(this.end=t(n))):new e(i,n)}function i(t,e,n,r){return this instanceof i?(void 0===e&&(e=t.y,n=t.width,r=t.height,t=t.x),this.x=t,this.y=e,this.width=n,void(this.height=r)):new i(t,e,n,r)}function n(e,i,r){return this instanceof n?(e=t(e),this.x=e.x,this.y=e.y,this.a=i,void(this.b=r)):new n(e,i,r)}var r=Math,o=r.abs,s=r.cos,a=r.sin,h=r.sqrt,l=r.min,u=r.max,c=(r.atan,r.atan2),f=(r.acos,r.round),d=r.floor,p=r.PI,g=r.random,m=function(t){return 180*t/p%360},v=function(t,e){return e=e||!1,t=e?t:t%360,t*p/180},y=function(t,e){return e*Math.round(t/e)},x=function(t){return t%360+(0>t?360:0)};t.prototype={toString:function(){return this.x+"@"+this.y},adhereToRect:function(t){return t.containsPoint(this)?this:(this.x=l(u(this.x,t.x),t.x+t.width),this.y=l(u(this.y,t.y),t.y+t.height),this)},theta:function(e){e=t(e);var i=-(e.y-this.y),n=e.x-this.x,r=10,o=0==i.toFixed(r)&&0==n.toFixed(r)?0:c(i,n);return 0>o&&(o=2*p+o),180*o/p},distance:function(t){return e(this,t).length()},manhattanDistance:function(t){return o(t.x-this.x)+o(t.y-this.y)},offset:function(t,e){return this.x+=t||0,this.y+=e||0,this},magnitude:function(){return h(this.x*this.x+this.y*this.y)||.01},update:function(t,e){return this.x=t||0,this.y=e||0,this},round:function(t){return this.x=t?this.x.toFixed(t):f(this.x),this.y=t?this.y.toFixed(t):f(this.y),this},normalize:function(t){var e=(t||1)/this.magnitude();return this.x=e*this.x,this.y=e*this.y,this},difference:function(e){return t(this.x-e.x,this.y-e.y)},bearing:function(t){return e(this,t).bearing()},toPolar:function(e){e=e&&t(e)||t(0,0);var i=this.x,n=this.y;return this.x=h((i-e.x)*(i-e.x)+(n-e.y)*(n-e.y)),this.y=v(e.theta(t(i,n))),this},rotate:function(e,i){i=(i+360)%360,this.toPolar(e),this.y+=v(i);var n=t.fromPolar(this.x,this.y,e);return this.x=n.x,this.y=n.y,this},move:function(e,i){var n=v(t(e).theta(this));return this.offset(s(n)*i,-a(n)*i)},changeInAngle:function(e,i,n){return t(this).offset(-e,-i).theta(n)-this.theta(n)},equals:function(t){return this.x===t.x&&this.y===t.y},snapToGrid:function(t,e){return this.x=y(this.x,t),this.y=y(this.y,e||t),this},reflection:function(e){return t(e).move(this,this.distance(e))}},t.fromPolar=function(e,i,n){n=n&&t(n)||t(0,0);var r=o(e*s(i)),h=o(e*a(i)),l=x(m(i));return 90>l?h=-h:180>l?(r=-r,h=-h):270>l&&(r=-r),t(n.x+r,n.y+h)},t.random=function(e,i,n,r){return t(d(g()*(i-e+1)+e),d(g()*(r-n+1)+n))},e.prototype={toString:function(){return this.start.toString()+" "+this.end.toString()},length:function(){return h(this.squaredLength())},squaredLength:function(){var t=this.start.x,e=this.start.y,i=this.end.x,n=this.end.y;return(t-=i)*t+(e-=n)*e},midpoint:function(){return t((this.start.x+this.end.x)/2,(this.start.y+this.end.y)/2)},intersection:function(e){var i=t(this.end.x-this.start.x,this.end.y-this.start.y),n=t(e.end.x-e.start.x,e.end.y-e.start.y),r=i.x*n.y-i.y*n.x,o=t(e.start.x-this.start.x,e.start.y-this.start.y),s=o.x*n.y-o.y*n.x,a=o.x*i.y-o.y*i.x;if(0===r||0>s*r||0>a*r)return null;if(r>0){if(s>r||a>r)return null}else if(r>s||r>a)return null;return t(this.start.x+s*i.x/r,this.start.y+s*i.y/r)},bearing:function(){var t=v(this.start.y),e=v(this.end.y),i=this.start.x,n=this.end.x,r=v(n-i),o=a(r)*s(e),h=s(t)*a(e)-a(t)*s(e)*s(r),l=m(c(o,h)),u=["NE","E","SE","S","SW","W","NW","N"],f=l-22.5;return 0>f&&(f+=360),f=parseInt(f/45),u[f]},pointAt:function(e){var i=(1-e)*this.start.x+e*this.end.x,n=(1-e)*this.start.y+e*this.end.y;return t(i,n)}},i.prototype={toString:function(){return this.origin().toString()+" "+this.corner().toString()},origin:function(){return t(this.x,this.y)},corner:function(){return t(this.x+this.width,this.y+this.height)},topRight:function(){return t(this.x+this.width,this.y)},bottomLeft:function(){return t(this.x,this.y+this.height)},center:function(){return t(this.x+this.width/2,this.y+this.height/2)},intersect:function(t){var e=this.origin(),i=this.corner(),n=t.origin(),r=t.corner();return r.x<=e.x||r.y<=e.y||n.x>=i.x||n.y>=i.y?!1:!0},sideNearestToPoint:function(e){e=t(e);var i=e.x-this.x,n=this.x+this.width-e.x,r=e.y-this.y,o=this.y+this.height-e.y,s=i,a="left";return s>n&&(s=n,a="right"),s>r&&(s=r,a="top"),s>o&&(s=o,a="bottom"),a},containsPoint:function(e){return e=t(e),e.x>=this.x&&e.x<=this.x+this.width&&e.y>=this.y&&e.y<=this.y+this.height?!0:!1},containsRect:function(t){var e=i(t).normalize(),n=e.width,r=e.height,o=e.x,s=e.y,a=this.width,h=this.height;if(0>(a|h|n|r))return!1;var l=this.x,u=this.y;if(l>o||u>s)return!1;if(a+=l,n+=o,o>=n){if(a>=l||n>a)return!1}else if(a>=l&&n>a)return!1;if(h+=u,r+=s,s>=r){if(h>=u||r>h)return!1}else if(h>=u&&r>h)return!1;return!0},pointNearestToPoint:function(e){if(e=t(e),this.containsPoint(e)){var i=this.sideNearestToPoint(e);switch(i){case"right":return t(this.x+this.width,e.y);case"left":return t(this.x,e.y);case"bottom":return t(e.x,this.y+this.height);case"top":return t(e.x,this.y)}}return e.adhereToRect(this)},intersectionWithLineFromCenterToPoint:function(i,n){i=t(i);var r,o=t(this.x+this.width/2,this.y+this.height/2);n&&i.rotate(o,n);for(var s=[e(this.origin(),this.topRight()),e(this.topRight(),this.corner()),e(this.corner(),this.bottomLeft()),e(this.bottomLeft(),this.origin())],a=e(o,i),h=s.length-1;h>=0;--h){var l=s[h].intersection(a);if(null!==l){r=l;break}}return r&&n&&r.rotate(o,-n),r},moveAndExpand:function(t){return this.x+=t.x,this.y+=t.y,this.width+=t.width,this.height+=t.height,this},round:function(t){return this.x=t?this.x.toFixed(t):f(this.x),this.y=t?this.y.toFixed(t):f(this.y),this.width=t?this.width.toFixed(t):f(this.width),this.height=t?this.height.toFixed(t):f(this.height),this},normalize:function(){var t=this.x,e=this.y,i=this.width,n=this.height;return this.width<0&&(t=this.x+this.width,i=-this.width),this.height<0&&(e=this.y+this.height,n=-this.height),this.x=t,this.y=e,this.width=i,this.height=n,this},bbox:function(t){var e=v(t||0),n=o(a(e)),r=o(s(e)),h=this.width*r+this.height*n,l=this.width*n+this.height*r;return i(this.x+(this.width-h)/2,this.y+(this.height-l)/2,h,l)}},n.prototype={toString:function(){return t(this.x,this.y).toString()+" "+this.a+" "+this.b},bbox:function(){return i(this.x-this.a,this.y-this.b,2*this.a,2*this.b)},intersectionWithLineFromCenterToPoint:function(e,i){e=t(e),i&&e.rotate(t(this.x,this.y),i);var n,r=e.x-this.x,o=e.y-this.y;if(0===r)return n=this.bbox().pointNearestToPoint(e),i?n.rotate(t(this.x,this.y),-i):n;var s=o/r,a=s*s,l=this.a*this.a,u=this.b*this.b,c=h(1/(1/l+a/u));c=0>r?-c:c;var f=s*c;return n=t(this.x+c,this.y+f),i?n.rotate(t(this.x,this.y),-i):n}};var _={curveThroughPoints:function(t){for(var e=this.getCurveControlPoints(t),i=["M",t[0].x,t[0].y],n=0;n<e[0].length;n++)i.push("C",e[0][n].x,e[0][n].y,e[1][n].x,e[1][n].y,t[n+1].x,t[n+1].y);return i},getCurveControlPoints:function(e){var i,n=[],r=[],o=e.length-1;if(1==o)return n[0]=t((2*e[0].x+e[1].x)/3,(2*e[0].y+e[1].y)/3),r[0]=t(2*n[0].x-e[0].x,2*n[0].y-e[0].y),[n,r];var s=[];for(i=1;o-1>i;i++)s[i]=4*e[i].x+2*e[i+1].x;s[0]=e[0].x+2*e[1].x,s[o-1]=(8*e[o-1].x+e[o].x)/2;var a=this.getFirstControlPoints(s);for(i=1;o-1>i;++i)s[i]=4*e[i].y+2*e[i+1].y;s[0]=e[0].y+2*e[1].y,s[o-1]=(8*e[o-1].y+e[o].y)/2;var h=this.getFirstControlPoints(s);for(i=0;o>i;i++)n.push(t(a[i],h[i])),r.push(o-1>i?t(2*e[i+1].x-a[i+1],2*e[i+1].y-h[i+1]):t((e[o].x+a[o-1])/2,(e[o].y+h[o-1])/2));return[n,r]},getFirstControlPoints:function(t){var e=t.length,i=[],n=[],r=2;i[0]=t[0]/r;for(var o=1;e>o;o++)n[o]=1/r,r=(e-1>o?4:3.5)-n[o],i[o]=(t[o]-i[o-1])/r;for(o=1;e>o;o++)i[e-o-1]-=n[e-o]*i[e-o];return i},getInversionSolver:function(t,e){function i(t,e){var i=n[t],r=n[e];return function(n){var o=(t%3?3:1)*(e%3?3:1),s=n.x*(i.y-r.y)+n.y*(r.x-i.x)+i.x*r.y-i.y*r.x;return o*s}}var n=arguments;return function(n){var r=3*i(2,3)(e),o=i(1,3)(t)/r,s=-i(2,3)(t)/r,a=o*i(3,1)(n)+s*(i(3,0)(n)+i(2,1)(n))+i(2,0)(n),h=o*i(3,0)(n)+s*i(2,0)(n)+i(1,0)(n);return h/(h-a)}},getCurveDivider:function(t,i,n,r){return function(o){var s=e(t,i).pointAt(o),a=e(i,n).pointAt(o),h=e(n,r).pointAt(o),l=e(s,a).pointAt(o),u=e(a,h).pointAt(o),c=e(l,u).pointAt(o);return[{p0:t,p1:s,p2:l,p3:c},{p0:c,p1:u,p2:h,p3:r}]}}},b={linear:function(t,e,i){var n=t[1]-t[0],r=e[1]-e[0];return(i-t[0])/n*r+e[0]||0}};return{toDeg:m,toRad:v,snapToGrid:y,normalizeAngle:x,point:t,line:e,rect:i,ellipse:n,bezier:_,scale:b}}),"object"==typeof exports)var _=require("lodash");var joint={version:"[%= pkg.version %]",dia:{},ui:{},layout:{},shapes:{},format:{},connectors:{},routers:{},util:{hashCode:function(t){var e=0;if(0==t.length)return e;for(var i=0;i<t.length;i++){var n=t.charCodeAt(i);e=(e<<5)-e+n,e&=e}return e},getByPath:function(t,e,i){i=i||".";for(var n,r=e.split(i);r.length;){if(n=r.shift(),!(n in t))return void 0;t=t[n]}return t},setByPath:function(t,e,i,n){n=n||".";var r=e.split(n),o=t,s=0;if(e.indexOf(n)>-1){for(var a=r.length;a-1>s;s++)o=o[r[s]]||(o[r[s]]={});o[r[a-1]]=i}else t[e]=i;return t},unsetByPath:function(t,e,i){i=i||".";var n=e.lastIndexOf(i);if(n>-1){var r=joint.util.getByPath(t,e.substr(0,n),i);r&&delete r[e.slice(n+1)]}else delete t[e];return t
},flattenObject:function(t,e,i){e=e||".";var n={};for(var r in t)if(t.hasOwnProperty(r)){var o="object"==typeof t[r];if(o&&i&&i(t[r])&&(o=!1),o){var s=this.flattenObject(t[r],e,i);for(var a in s)s.hasOwnProperty(a)&&(n[r+e+a]=s[a])}else n[r]=t[r]}return n},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,i="x"==t?e:3&e|8;return i.toString(16)})},guid:function(t){return this.guid.id=this.guid.id||1,t.id=void 0===t.id?"j_"+this.guid.id++:t.id,t.id},mixin:function(){for(var t=arguments[0],e=1,i=arguments.length;i>e;e++){var n=arguments[e];(Object(n)===n||_.isFunction(n)||null!==n&&void 0!==n)&&_.each(n,function(e,i){return this.mixin.deep&&Object(e)===e?(t[i]||(t[i]=_.isArray(e)?[]:{}),void this.mixin(t[i],e)):void(t[i]!==e&&(this.mixin.supplement&&t.hasOwnProperty(i)||(t[i]=e)))},this)}return t},supplement:function(){this.mixin.supplement=!0;var t=this.mixin.apply(this,arguments);return this.mixin.supplement=!1,t},deepMixin:function(){this.mixin.deep=!0;var t=this.mixin.apply(this,arguments);return this.mixin.deep=!1,t},deepSupplement:function(){this.mixin.deep=this.mixin.supplement=!0;var t=this.mixin.apply(this,arguments);return this.mixin.deep=this.mixin.supplement=!1,t},normalizeEvent:function(t){return t.originalEvent&&t.originalEvent.changedTouches&&t.originalEvent.changedTouches.length?t.originalEvent.changedTouches[0]:t},nextFrame:function(){var t,e="undefined"!=typeof window;if(e&&(t=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame),!t){var i=0;t=function(t){var e=(new Date).getTime(),n=Math.max(0,16-(e-i)),r=setTimeout(function(){t(e+n)},n);return i=e+n,r}}return e?_.bind(t,window):t}(),cancelFrame:function(){var t,e="undefined"!=typeof window;return e&&(t=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.msCancelRequestAnimationFrame||window.oCancelAnimationFrame||window.oCancelRequestAnimationFrame||window.mozCancelAnimationFrame||window.mozCancelRequestAnimationFrame),t=t||clearTimeout,e?_.bind(t,window):t}(),breakText:function(t,e,i,n){n=n||{};var r=e.width,o=e.height,s=n.svgDocument||V("svg").node,a=V("<text><tspan></tspan></text>").attr(i||{}).node,h=a.firstChild,l=document.createTextNode("");h.appendChild(l),s.appendChild(a),n.svgDocument||document.body.appendChild(s);for(var u,c=t.split(" "),f=[],d=[],p=0,g=0,m=c.length;m>p;p++){var v=c[p];if(l.data=d[g]?d[g]+" "+v:v,h.getComputedTextLength()<=r)d[g]=l.data,u&&(f[g++]=!0,u=0);else{if(!d[g]||u){var y=!!u;if(u=v.length-1,y||!u){if(!u){if(!d[g]){d=[];break}c.splice(p,2,v+c[p+1]),m--,f[g++]=!0,p--;continue}c[p]=v.substring(0,u),c[p+1]=v.substring(u)+c[p+1]}else c.splice(p,1,v.substring(0,u),v.substring(u)),m++,g&&!f[g-1]&&g--;p--;continue}g++,p--}if("undefined"!=typeof o){var x=x||1.25*a.getBBox().height;if(x*d.length>o){d.splice(Math.floor(o/x));break}}}return n.svgDocument?s.removeChild(a):document.body.removeChild(s),d.join("\n")},imageToDataUri:function(t,e){if("data:"===t.substr(0,"data:".length))return setTimeout(function(){e(null,t)},0);var i=document.createElement("canvas"),n=document.createElement("img");n.onload=function(){var r=i.getContext("2d");i.width=n.width,i.height=n.height,r.drawImage(n,0,0);try{var o=(t.split(".").pop()||"png","jpeg"),s=i.toDataURL(o)}catch(a){if(/\.svg$/.test(t)){var h=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");h.open("GET",t,!1),h.send(null);var l=h.responseText;return e(null,"data:image/svg+xml,"+encodeURIComponent(l))}console.error(n.src,"fails to convert",a)}e(null,s)},n.ononerror=function(){e(new Error("Failed to load image."))},n.src=t},timing:{linear:function(t){return t},quad:function(t){return t*t},cubic:function(t){return t*t*t},inout:function(t){if(0>=t)return 0;if(t>=1)return 1;var e=t*t,i=e*t;return 4*(.5>t?i:3*(t-e)+i-.75)},exponential:function(t){return Math.pow(2,10*(t-1))},bounce:function(t){for(var e=0,i=1;1;e+=i,i/=2)if(t>=(7-4*e)/11){var n=(11-6*e-11*t)/4;return-n*n+i*i}},reverse:function(t){return function(e){return 1-t(1-e)}},reflect:function(t){return function(e){return.5*(.5>e?t(2*e):2-t(2-2*e))}},clamp:function(t,e,i){return e=e||0,i=i||1,function(n){var r=t(n);return e>r?e:r>i?i:r}},back:function(t){return t||(t=1.70158),function(e){return e*e*((t+1)*e-t)}},elastic:function(t){return t||(t=1.5),function(e){return Math.pow(2,10*(e-1))*Math.cos(20*Math.PI*t/3*e)}}},interpolate:{number:function(t,e){var i=e-t;return function(e){return t+i*e}},object:function(t,e){var i=_.keys(t);return function(n){var r,o,s={};for(r=i.length-1;-1!=r;r--)o=i[r],s[o]=t[o]+(e[o]-t[o])*n;return s}},hexColor:function(t,e){var i=parseInt(t.slice(1),16),n=parseInt(e.slice(1),16),r=255&i,o=(255&n)-r,s=65280&i,a=(65280&n)-s,h=16711680&i,l=(16711680&n)-h;return function(t){var e=r+o*t&255,i=s+a*t&65280,n=h+l*t&16711680;return"#"+(1<<24|e|i|n).toString(16).slice(1)}},unit:function(t,e){var i=/(-?[0-9]*.[0-9]*)(px|em|cm|mm|in|pt|pc|%)/,n=i.exec(t),r=i.exec(e),o=r[1].indexOf("."),s=o>0?r[1].length-o-1:0,t=+n[1],a=+r[1]-t,h=n[2];return function(e){return(t+a*e).toFixed(s)+h}}},filter:{blur:function(t){var e=_.isFinite(t.x)?t.x:2;return _.template('<filter><feGaussianBlur stdDeviation="${stdDeviation}"/></filter>',{stdDeviation:_.isFinite(t.y)?[e,t.y]:e})},dropShadow:function(t){var e="SVGFEDropShadowElement"in window?'<filter><feDropShadow stdDeviation="${blur}" dx="${dx}" dy="${dy}" flood-color="${color}" flood-opacity="${opacity}"/></filter>':'<filter><feGaussianBlur in="SourceAlpha" stdDeviation="${blur}"/><feOffset dx="${dx}" dy="${dy}" result="offsetblur"/><feFlood flood-color="${color}"/><feComposite in2="offsetblur" operator="in"/><feComponentTransfer><feFuncA type="linear" slope="${opacity}"/></feComponentTransfer><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge></filter>';return _.template(e,{dx:t.dx||0,dy:t.dy||0,opacity:_.isFinite(t.opacity)?t.opacity:1,color:t.color||"black",blur:_.isFinite(t.blur)?t.blur:4})},grayscale:function(t){var e=_.isFinite(t.amount)?t.amount:1;return _.template('<filter><feColorMatrix type="matrix" values="${a} ${b} ${c} 0 0 ${d} ${e} ${f} 0 0 ${g} ${b} ${h} 0 0 0 0 0 1 0"/></filter>',{a:.2126+.7874*(1-e),b:.7152-.7152*(1-e),c:.0722-.0722*(1-e),d:.2126-.2126*(1-e),e:.7152+.2848*(1-e),f:.0722-.0722*(1-e),g:.2126-.2126*(1-e),h:.0722+.9278*(1-e)})},sepia:function(t){var e=_.isFinite(t.amount)?t.amount:1;return _.template('<filter><feColorMatrix type="matrix" values="${a} ${b} ${c} 0 0 ${d} ${e} ${f} 0 0 ${g} ${h} ${i} 0 0 0 0 0 1 0"/></filter>',{a:.393+.607*(1-e),b:.769-.769*(1-e),c:.189-.189*(1-e),d:.349-.349*(1-e),e:.686+.314*(1-e),f:.168-.168*(1-e),g:.272-.272*(1-e),h:.534-.534*(1-e),i:.131+.869*(1-e)})},saturate:function(t){var e=_.isFinite(t.amount)?t.amount:1;return _.template('<filter><feColorMatrix type="saturate" values="${amount}"/></filter>',{amount:1-e})},hueRotate:function(t){return _.template('<filter><feColorMatrix type="hueRotate" values="${angle}"/></filter>',{angle:t.angle||0})},invert:function(t){var e=_.isFinite(t.amount)?t.amount:1;return _.template('<filter><feComponentTransfer><feFuncR type="table" tableValues="${amount} ${amount2}"/><feFuncG type="table" tableValues="${amount} ${amount2}"/><feFuncB type="table" tableValues="${amount} ${amount2}"/></feComponentTransfer></filter>',{amount:e,amount2:1-e})},brightness:function(t){return _.template('<filter><feComponentTransfer><feFuncR type="linear" slope="${amount}"/><feFuncG type="linear" slope="${amount}"/><feFuncB type="linear" slope="${amount}"/></feComponentTransfer></filter>',{amount:_.isFinite(t.amount)?t.amount:1})},contrast:function(t){var e=_.isFinite(t.amount)?t.amount:1;return _.template('<filter><feComponentTransfer><feFuncR type="linear" slope="${amount}" intercept="${amount2}"/><feFuncG type="linear" slope="${amount}" intercept="${amount2}"/><feFuncB type="linear" slope="${amount}" intercept="${amount2}"/></feComponentTransfer></filter>',{amount:e,amount2:.5-e/2})}},format:{number:function(t,e,i){function n(t){for(var e=t.length,n=[],r=0,o=i.grouping[0];e>0&&o>0;)n.push(t.substring(e-=o,e+o)),o=i.grouping[r=(r+1)%i.grouping.length];return n.reverse().join(i.thousands)}i=i||{currency:["$",""],decimal:".",thousands:",",grouping:[3]};var r=/(?:([^{])?([<>=^]))?([+\- ])?([$#])?(0)?(\d+)?(,)?(\.-?\d+)?([a-z%])?/i,o=r.exec(t),s=o[1]||" ",a=o[2]||">",h=o[3]||"",l=o[4]||"",u=o[5],c=+o[6],f=o[7],d=o[8],p=o[9],g=1,m="",v="",y=!1;switch(d&&(d=+d.substring(1)),(u||"0"===s&&"="===a)&&(u=s="0",a="=",f&&(c-=Math.floor((c-1)/4))),p){case"n":f=!0,p="g";break;case"%":g=100,v="%",p="f";break;case"p":g=100,v="%",p="r";break;case"b":case"o":case"x":case"X":"#"===l&&(m="0"+p.toLowerCase());case"c":case"d":y=!0,d=0;break;case"s":g=-1,p="r"}"$"===l&&(m=i.currency[0],v=i.currency[1]),"r"!=p||d||(p="g"),null!=d&&("g"==p?d=Math.max(1,Math.min(21,d)):("e"==p||"f"==p)&&(d=Math.max(0,Math.min(20,d))));var x=u&&f;if(y&&e%1)return"";var _=0>e||0===e&&0>1/e?(e=-e,"-"):h,b=v;if(0>g){var w=this.prefix(e,d);e=w.scale(e),b=w.symbol+v}else e*=g;e=this.convert(p,e,d);var k=e.lastIndexOf("."),j=0>k?e:e.substring(0,k),C=0>k?"":i.decimal+e.substring(k+1);!u&&f&&i.grouping&&(j=n(j));var V=m.length+j.length+C.length+(x?0:_.length),M=c>V?new Array(V=c-V+1).join(s):"";return x&&(j=n(M+j)),_+=m,e=j+C,("<"===a?_+e+M:">"===a?M+_+e:"^"===a?M.substring(0,V>>=1)+_+e+M.substring(V):_+(x?e:M+e))+b},string:function(t,e){for(var i,n="{",r=!1,o=[];-1!==(i=t.indexOf(n));){var s,a,h;if(s=t.slice(0,i),r){a=s.split(":"),h=a.shift().split("."),s=e;for(var l=0;l<h.length;l++)s=s[h[l]];a.length&&(s=this.number(a,s))}o.push(s),t=t.slice(i+1),n=(r=!r)?"}":"{"}return o.push(t),o.join("")},convert:function(t,e,i){switch(t){case"b":return e.toString(2);case"c":return String.fromCharCode(e);case"o":return e.toString(8);case"x":return e.toString(16);case"X":return e.toString(16).toUpperCase();case"g":return e.toPrecision(i);case"e":return e.toExponential(i);case"f":return e.toFixed(i);case"r":return(e=this.round(e,this.precision(e,i))).toFixed(Math.max(0,Math.min(20,this.precision(e*(1+1e-15),i))));default:return e+""}},round:function(t,e){return e?Math.round(t*(e=Math.pow(10,e)))/e:Math.round(t)},precision:function(t,e){return e-(t?Math.ceil(Math.log(t)/Math.LN10):1)},prefix:function(t,e){var i=_.map(["y","z","a","f","p","n","µ","m","","k","M","G","T","P","E","Z","Y"],function(t,e){var i=Math.pow(10,3*abs(8-e));return{scale:e>8?function(t){return t/i}:function(t){return t*i},symbol:t}}),n=0;return t&&(0>t&&(t*=-1),e&&(t=d3.round(t,this.precision(t,e))),n=1+Math.floor(1e-12+Math.log(t)/Math.LN10),n=Math.max(-24,Math.min(24,3*Math.floor((0>=n?n+1:n-1)/3)))),i[8+n/3]}}}};if("object"==typeof exports&&(module.exports=joint),"object"==typeof exports)var joint={dia:{Link:require("./joint.dia.link").Link,Element:require("./joint.dia.element").Element},shapes:require("../plugins/shapes")},Backbone=require("backbone"),_=require("lodash"),g=require("./geometry");if(joint.dia.GraphCells=Backbone.Collection.extend({initialize:function(){this.on("change:z",this.sort,this)},model:function(t,e){if("link"===t.type)return new joint.dia.Link(t,e);var i=t.type.split(".")[0],n=t.type.split(".")[1];return joint.shapes[i]&&joint.shapes[i][n]?new joint.shapes[i][n](t,e):new joint.dia.Element(t,e)},comparator:function(t){return t.get("z")||0},getConnectedLinks:function(t,e){e=e||{},_.isUndefined(e.inbound)&&_.isUndefined(e.outbound)&&(e.inbound=e.outbound=!0);var i=[];return this.each(function(n){var r=n.get("source"),o=n.get("target");r&&r.id===t.id&&e.outbound&&i.push(n),o&&o.id===t.id&&e.inbound&&i.push(n)}),i}}),joint.dia.Graph=Backbone.Model.extend({initialize:function(){this.set("cells",new joint.dia.GraphCells),this.get("cells").on("all",this.trigger,this),this.get("cells").on("remove",this.removeCell,this)},toJSON:function(){var t=Backbone.Model.prototype.toJSON.apply(this,arguments);return t.cells=this.get("cells").toJSON(),t},fromJSON:function(t,e){if(!t.cells)throw new Error("Graph JSON must contain cells array.");this.set(_.omit(t,"cells"),e),this.resetCells(t.cells,e)},clear:function(t){this.trigger("batch:start"),this.get("cells").remove(this.get("cells").models,t),this.trigger("batch:stop")},_prepareCell:function(t){return t instanceof Backbone.Model&&_.isUndefined(t.get("z"))?t.set("z",this.maxZIndex()+1,{silent:!0}):_.isUndefined(t.z)&&(t.z=this.maxZIndex()+1),t},maxZIndex:function(){var t=this.get("cells").last();return t?t.get("z")||0:0},addCell:function(t,e){return _.isArray(t)?this.addCells(t,e):(this.get("cells").add(this._prepareCell(t),e||{}),this)},addCells:function(t,e){return e=e||{},e.position=t.length,_.each(t,function(t){e.position--,this.addCell(t,e)},this),this},resetCells:function(t,e){return this.get("cells").reset(_.map(t,this._prepareCell,this),e),this},removeCell:function(t,e,i){i&&i.disconnectLinks?this.disconnectLinks(t):this.removeLinks(t),this.get("cells").remove(t,{silent:!0})},getCell:function(t){return this.get("cells").get(t)},getElements:function(){return this.get("cells").filter(function(t){return t instanceof joint.dia.Element})},getLinks:function(){return this.get("cells").filter(function(t){return t instanceof joint.dia.Link})},getConnectedLinks:function(t,e){return this.get("cells").getConnectedLinks(t,e)},getNeighbors:function(t){var e=this.getConnectedLinks(t),i=[],n=this.get("cells");return _.each(e,function(e){var r=e.get("source"),o=e.get("target");if(!r.x){var s=n.get(r.id);s!==t&&i.push(s)}if(!o.x){var a=n.get(o.id);a!==t&&i.push(a)}}),i},disconnectLinks:function(t){_.each(this.getConnectedLinks(t),function(e){e.set(e.get("source").id===t.id?"source":"target",g.point(0,0))})},removeLinks:function(t){_.invoke(this.getConnectedLinks(t),"remove")},findModelsFromPoint:function(t){return _.filter(this.getElements(),function(e){return e.getBBox().containsPoint(t)})},findModelsInArea:function(t){return _.filter(this.getElements(),function(e){return e.getBBox().intersect(t)})},getBBox:function(t){var e={x:1/0,y:1/0},i={x:0,y:0};return _.each(t,function(t){var n=t.getBBox();e.x=Math.min(e.x,n.x),e.y=Math.min(e.y,n.y),i.x=Math.max(i.x,n.x+n.width),i.y=Math.max(i.y,n.y+n.height)}),g.rect(e.x,e.y,i.x-e.x,i.y-e.y)}}),"object"==typeof exports&&(module.exports.Graph=joint.dia.Graph),"object"==typeof exports)var joint={util:require("./core").util,dia:{Link:require("./joint.dia.link").Link}},Backbone=require("backbone"),_=require("lodash");if(joint.dia.Cell=Backbone.Model.extend({constructor:function(t,e){var i,n=t||{};this.cid=_.uniqueId("c"),this.attributes={},e&&e.collection&&(this.collection=e.collection),e&&e.parse&&(n=this.parse(n,e)||{}),(i=_.result(this,"defaults"))&&(n=_.merge({},i,n)),this.set(n,e),this.changed={},this.initialize.apply(this,arguments)},toJSON:function(){var t=this.constructor.prototype.defaults.attrs||{},e=this.attributes.attrs,i={};_.each(e,function(e,n){var r=t[n];_.each(e,function(t,e){_.isObject(t)&&!_.isArray(t)?_.each(t,function(t,o){r&&r[e]&&_.isEqual(r[e][o],t)||(i[n]=i[n]||{},(i[n][e]||(i[n][e]={}))[o]=t)}):r&&_.isEqual(r[e],t)||(i[n]=i[n]||{},i[n][e]=t)})});var n=_.cloneDeep(_.omit(this.attributes,"attrs"));return n.attrs=i,n},initialize:function(t){t&&t.id||this.set("id",joint.util.uuid(),{silent:!0}),this._transitionIds={},this.processPorts(),this.on("change:attrs",this.processPorts,this)},processPorts:function(){var t=this.ports,e={};_.each(this.get("attrs"),function(t){t&&t.port&&(_.isUndefined(t.port.id)?e[t.port]={id:t.port}:e[t.port.id]=t.port)});var i={};if(_.each(t,function(t,n){e[n]||(i[n]=!0)}),this.collection&&!_.isEmpty(i)){var n=this.collection.getConnectedLinks(this,{inbound:!0});_.each(n,function(t){i[t.get("target").port]&&t.remove()});var r=this.collection.getConnectedLinks(this,{outbound:!0});_.each(r,function(t){i[t.get("source").port]&&t.remove()})}this.ports=e},remove:function(t){var e=this.collection;e&&e.trigger("batch:start");var i=this.get("parent");if(i){var n=this.collection&&this.collection.get(i);n.unembed(this)}return _.invoke(this.getEmbeddedCells(),"remove",t),this.trigger("remove",this,this.collection,t),e&&e.trigger("batch:stop"),this},toFront:function(){return this.collection&&this.set("z",(this.collection.last().get("z")||0)+1),this},toBack:function(){return this.collection&&this.set("z",(this.collection.first().get("z")||0)-1),this},embed:function(t){if(this.get("parent")==t.id)throw new Error("Recursive embedding not allowed.");return this.trigger("batch:start"),t.set("parent",this.id),this.set("embeds",_.uniq((this.get("embeds")||[]).concat([t.id]))),this.trigger("batch:stop"),this},unembed:function(t){this.trigger("batch:start");var e=t.id;return t.unset("parent"),this.set("embeds",_.without(this.get("embeds"),e)),this.trigger("batch:stop"),this},getEmbeddedCells:function(){return this.collection?_.map(this.get("embeds")||[],function(t){return this.collection.get(t)},this):[]},clone:function(t){t=t||{};var e=Backbone.Model.prototype.clone.apply(this,arguments);if(e.set("id",joint.util.uuid(),{silent:!0}),e.set("embeds",""),!t.deep)return e;var i=_.sortBy(this.getEmbeddedCells(),function(t){return t instanceof joint.dia.Element}),n=[e],r={};return _.each(i,function(t){var i=t.clone({deep:!0});e.embed(i[0]),_.each(i,function(i){if(i instanceof joint.dia.Link)return i.get("source").id==this.id&&i.prop("source",{id:e.id}),i.get("target").id==this.id&&i.prop("target",{id:e.id}),void(r[t.id]=i);n.push(i);var o=this.collection.getConnectedLinks(t,{inbound:!0});_.each(o,function(t){var e=r[t.id]||t.clone();r[t.id]=e,e.prop("target",{id:i.id})});var s=this.collection.getConnectedLinks(t,{outbound:!0});_.each(s,function(t){var e=r[t.id]||t.clone();r[t.id]=e,e.prop("source",{id:i.id})})},this)},this),n=n.concat(_.values(r))},prop:function(t,e,i){var n="/";if(_.isString(t)){if("undefined"!=typeof e){var r=t,o=r.split("/"),s=o[0];if(1==o.length)return this.set(s,e,i);var a={},h=a,l=s;_.each(_.rest(o),function(t){h=h[l]=_.isFinite(Number(t))?[]:{},l=t}),a=joint.util.setByPath(a,r,e,"/");var u=_.merge({},this.attributes,a);return this.set(s,u[s],i)}return joint.util.getByPath(this.attributes,t,n)}return this.set(_.merge({},this.attributes,t),e)},attr:function(t,e,i){var n=this.get("attrs"),r="/";if(_.isString(t)){if("undefined"!=typeof e){var o={};return joint.util.setByPath(o,t,e,r),this.set("attrs",_.merge({},n,o),i)}return joint.util.getByPath(n,t,r)}return this.set("attrs",_.merge({},n,t),e,i)},removeAttr:function(t,e){if(_.isArray(t))return _.each(t,function(t){this.removeAttr(t,e)},this),this;var i=joint.util.unsetByPath(_.merge({},this.get("attrs")),t,"/");return this.set("attrs",i,_.extend({dirty:!0},e))},transition:function(t,e,i,n){n=n||"/";var r={duration:100,delay:10,timingFunction:joint.util.timing.linear,valueFunction:joint.util.interpolate.number};i=_.extend(r,i);var o,s=0,a=_.bind(function(e){var n,r,h;s=s||e,e-=s,r=e/i.duration,1>r?this._transitionIds[t]=n=joint.util.nextFrame(a):(r=1,delete this._transitionIds[t]),h=o(i.timingFunction(r)),i.transitionId=n,this.prop(t,h,i),n||this.trigger("transition:end",this,t)},this),h=_.bind(function(r){this.stopTransitions(t),o=i.valueFunction(joint.util.getByPath(this.attributes,t,n),e),this._transitionIds[t]=joint.util.nextFrame(r),this.trigger("transition:start",this,t)},this);return _.delay(h,i.delay,a)},getTransitions:function(){return _.keys(this._transitionIds)},stopTransitions:function(t,e){e=e||"/";var i=t&&t.split(e);return _(this._transitionIds).keys().filter(i&&function(t){return _.isEqual(i,t.split(e).slice(0,i.length))}).each(function(t){joint.util.cancelFrame(this._transitionIds[t]),delete this._transitionIds[t],this.trigger("transition:end",this,t)},this),this},addTo:function(t){return t.addCell(this),this},findView:function(t){return t.findViewByModel(this)}}),joint.dia.CellView=Backbone.View.extend({tagName:"g",attributes:function(){return{"model-id":this.model.id}},constructor:function(t){this._configure(t),Backbone.View.apply(this,arguments)},_configure:function(t){this.options&&(t=_.extend({},_.result(this,"options"),t)),this.options=t,this.options.id=this.options.id||joint.util.guid(this)},initialize:function(){_.bindAll(this,"remove","update"),this.$el.data("view",this),this.listenTo(this.model,"remove",this.remove),this.listenTo(this.model,"change:attrs",this.onChangeAttrs)},onChangeAttrs:function(t,e,i){return i.dirty?this.render():this.update()},_ensureElement:function(){var t;if(this.el)t=_.result(this,"el");else{var e=_.extend({id:this.id},_.result(this,"attributes"));this.className&&(e["class"]=_.result(this,"className")),t=V(_.result(this,"tagName"),e).node}this.setElement(t,!1)},findBySelector:function(t){var e="."===t?this.$el:this.$el.find(t);return e},notify:function(t){if(this.paper){var e=Array.prototype.slice.call(arguments,1);this.trigger.apply(this,[t].concat(e)),this.paper.trigger.apply(this.paper,[t,this].concat(e))}},getStrokeBBox:function(t){var e=!!t;t=t||this.el;var i,n=V(t).bbox(!1,this.paper.viewport);return i=e?V(t).attr("stroke-width"):this.model.attr("rect/stroke-width")||this.model.attr("circle/stroke-width")||this.model.attr("ellipse/stroke-width")||this.model.attr("path/stroke-width"),i=parseFloat(i)||0,g.rect(n).moveAndExpand({x:-i/2,y:-i/2,width:i,height:i})},getBBox:function(){return V(this.el).bbox()},highlight:function(t){t=t?this.$(t)[0]||this.el:this.el,V(t).addClass("highlighted")},unhighlight:function(t){t=t?this.$(t)[0]||this.el:this.el,V(t).removeClass("highlighted")},findMagnet:function(t){var e=this.$(t);if(0===e.length||e[0]===this.el){var i=this.model.get("attrs")||{};return i["."]&&i["."].magnet===!1?void 0:this.el}return e.attr("magnet")?e[0]:this.findMagnet(e.parent())},applyFilter:function(t,e){var i=this.findBySelector(t),n=e.name+this.paper.svg.id+joint.util.hashCode(JSON.stringify(e));if(!this.paper.svg.getElementById(n)){var r=joint.util.filter[e.name]&&joint.util.filter[e.name](e.args||{});if(!r)throw new Error("Non-existing filter "+e.name);var o=V(r);o.attr({filterUnits:"objectBoundingBox",x:-1,y:-1,width:3,height:3}),e.attrs&&o.attr(e.attrs),o.node.id=n,V(this.paper.svg).defs().append(o)}i.each(function(){V(this).attr("filter","url(#"+n+")")})},applyGradient:function(t,e,i){var n=this.findBySelector(t),r=i.type+this.paper.svg.id+joint.util.hashCode(JSON.stringify(i));if(!this.paper.svg.getElementById(r)){var o=["<"+i.type+">",_.map(i.stops,function(t){return'<stop offset="'+t.offset+'" stop-color="'+t.color+'" stop-opacity="'+(_.isFinite(t.opacity)?t.opacity:1)+'" />'}).join(""),"</"+i.type+">"].join(""),s=V(o);i.attrs&&s.attr(i.attrs),s.node.id=r,V(this.paper.svg).defs().append(s)}n.each(function(){V(this).attr(e,"url(#"+r+")")})},getSelector:function(t,e){if(t===this.el)return e;var i=$(t).index();return e=t.tagName+":nth-child("+(i+1)+") "+(e||""),this.getSelector($(t).parent()[0],e+" ")},pointerdblclick:function(t,e,i){this.notify("cell:pointerdblclick",t,e,i)},pointerclick:function(t,e,i){this.notify("cell:pointerclick",t,e,i)},pointerdown:function(t,e,i){this.model.collection&&(this.model.trigger("batch:start"),this._collection=this.model.collection),this.notify("cell:pointerdown",t,e,i)},pointermove:function(t,e,i){this.notify("cell:pointermove",t,e,i)},pointerup:function(t,e,i){this.notify("cell:pointerup",t,e,i),this._collection&&(this._collection.trigger("batch:stop"),delete this._collection)}}),"object"==typeof exports&&(module.exports.Cell=joint.dia.Cell,module.exports.CellView=joint.dia.CellView),"object"==typeof exports)var joint={util:require("./core").util,dia:{Cell:require("./joint.dia.cell").Cell,CellView:require("./joint.dia.cell").CellView}},Backbone=require("backbone"),_=require("lodash");if(joint.dia.Element=joint.dia.Cell.extend({defaults:{position:{x:0,y:0},size:{width:1,height:1},angle:0},position:function(t,e){this.set("position",{x:t,y:e})},translate:function(t,e,i){if(e=e||0,0===t&&0===e)return this;var n=this.get("position")||{x:0,y:0},r={x:n.x+t||0,y:n.y+e||0};return i&&i.transition?(_.isObject(i.transition)||(i.transition={}),this.transition("position",r,_.extend({},i.transition,{valueFunction:joint.util.interpolate.object}))):(this.set("position",r,i),_.invoke(this.getEmbeddedCells(),"translate",t,e,i)),this},resize:function(t,e){return this.trigger("batch:start"),this.set("size",{width:t,height:e}),this.trigger("batch:stop"),this},rotate:function(t,e,i){if(i){var n=this.getBBox().center(),r=this.get("size"),o=this.get("position");n.rotate(i,(this.get("angle")||0)-t);var s=n.x-r.width/2-o.x,a=n.y-r.height/2-o.y;this.trigger("batch:start"),this.translate(s,a),this.rotate(t,e),this.trigger("batch:stop")}else this.set("angle",e?t:((this.get("angle")||0)+t)%360);return this},getBBox:function(){var t=this.get("position"),e=this.get("size");return g.rect(t.x,t.y,e.width,e.height)}}),joint.dia.ElementView=joint.dia.CellView.extend({className:function(){return"element "+this.model.get("type").split(".").join(" ")},initialize:function(){_.bindAll(this,"translate","resize","rotate"),joint.dia.CellView.prototype.initialize.apply(this,arguments),this.listenTo(this.model,"change:position",this.translate),this.listenTo(this.model,"change:size",this.resize),this.listenTo(this.model,"change:angle",this.rotate)},update:function(t,e){var i=this.model.get("attrs"),n=V(this.$(".rotatable")[0]);if(n){var r=n.attr("transform");n.attr("transform","")}var o=[];_.each(e||i,function(t,e){var i=this.findBySelector(e);if(0!==i.length){var n=["style","text","html","ref-x","ref-y","ref-dx","ref-dy","ref-width","ref-height","ref","x-alignment","y-alignment","port"];_.isObject(t.filter)&&(n.push("filter"),this.applyFilter(e,t.filter)),_.isObject(t.fill)&&(n.push("fill"),this.applyGradient(e,"fill",t.fill)),_.isObject(t.stroke)&&(n.push("stroke"),this.applyGradient(e,"stroke",t.stroke)),_.isUndefined(t.text)||i.each(function(){V(this).text(t.text+"",{lineHeight:t.lineHeight})});var r=_.omit(t,n);i.each(function(){V(this).attr(r)}),t.port&&i.attr("port",_.isUndefined(t.port.id)?t.port:t.port.id),t.style&&i.css(t.style),_.isUndefined(t.html)||i.each(function(){$(this).html(t.html+"")}),_.isUndefined(t["ref-x"])&&_.isUndefined(t["ref-y"])&&_.isUndefined(t["ref-dx"])&&_.isUndefined(t["ref-dy"])&&_.isUndefined(t["x-alignment"])&&_.isUndefined(t["y-alignment"])&&_.isUndefined(t["ref-width"])&&_.isUndefined(t["ref-height"])||_.each(i,function(t,e,i){var n=$(t);n.selector=i.selector,o.push(n)})}},this);var s=this.el.getBBox();e=e||{},_.each(o,function(t){var n=e[t.selector],r=n?_.merge({},i[t.selector],n):i[t.selector];this.positionRelative(t,s,r)},this),n&&n.attr("transform",r||"")},positionRelative:function(t,e,i){function n(t){return _.isNumber(t)&&!_.isNaN(t)}var r=i.ref,o=parseFloat(i["ref-x"]),s=parseFloat(i["ref-y"]),a=parseFloat(i["ref-dx"]),h=parseFloat(i["ref-dy"]),l=i["y-alignment"],u=i["x-alignment"],c=parseFloat(i["ref-width"]),f=parseFloat(i["ref-height"]),d=_.contains(_.pluck(_.pluck(t.parents("g"),"className"),"baseVal"),"scalable");r&&(e=V(this.findBySelector(r)[0]).bbox(!1,this.el));var p=V(t[0]);p.attr("transform")&&p.attr("transform",p.attr("transform").replace(/translate\([^)]*\)/g,"").trim()||"");var g=0,m=0;if(n(c)&&(c>=0&&1>=c?p.attr("width",c*e.width):p.attr("width",Math.max(c+e.width,0))),n(f)&&(f>=0&&1>=f?p.attr("height",f*e.height):p.attr("height",Math.max(f+e.height,0))),n(a))if(d){var v=V(this.$(".scalable")[0]).scale();g=e.x+e.width+a/v.sx}else g=e.x+e.width+a;if(n(h))if(d){var v=V(this.$(".scalable")[0]).scale();m=e.y+e.height+h/v.sy}else m=e.y+e.height+h;if(n(o))if(o>0&&1>o)g=e.x+e.width*o;else if(d){var v=V(this.$(".scalable")[0]).scale();g=e.x+o/v.sx}else g=e.x+o;if(n(s))if(s>0&&1>s)m=e.y+e.height*s;else if(d){var v=V(this.$(".scalable")[0]).scale();m=e.y+s/v.sy}else m=e.y+s;var y=p.bbox(!1,this.paper.viewport);"middle"===l?m-=y.height/2:n(l)&&(m+=l>-1&&1>l?y.height*l:l),"middle"===u?g-=y.width/2:n(u)&&(g+=u>-1&&1>u?y.width*u:u),p.translate(g,m)},renderMarkup:function(){var t=this.model.markup||this.model.get("markup");if(!t)throw new Error("properties.markup is missing while the default render() implementation is used.");var e=V(t);V(this.el).append(e)},render:function(){return this.$el.empty(),this.renderMarkup(),this.update(),this.resize(),this.rotate(),this.translate(),this},scale:function(t,e){V(this.el).scale(t,e)},resize:function(){var t=this.model.get("size")||{width:1,height:1},e=this.model.get("angle")||0,i=V(this.$(".scalable")[0]);if(i){var n=i.bbox(!0);i.attr("transform","scale("+t.width/(n.width||1)+","+t.height/(n.height||1)+")");var r=V(this.$(".rotatable")[0]),o=r&&r.attr("transform");if(o&&"null"!==o){r.attr("transform",o+" rotate("+-e+","+t.width/2+","+t.height/2+")");var s=i.bbox(!1,this.paper.viewport);this.model.set("position",{x:s.x,y:s.y}),this.rotate()}this.update()}},translate:function(){var t=this.model.get("position")||{x:0,y:0};V(this.el).attr("transform","translate("+t.x+","+t.y+")")},rotate:function(){var t=V(this.$(".rotatable")[0]);if(t){var e=this.model.get("angle")||0,i=this.model.get("size")||{width:1,height:1},n=i.width/2,r=i.height/2;t.attr("transform","rotate("+e+","+n+","+r+")")}},pointerdown:function(t,e,i){if(t.target.getAttribute("magnet")&&this.paper.options.validateMagnet.call(this.paper,this,t.target)){this.model.trigger("batch:start");var n=this.paper.getDefaultLink(this,t.target);n.set({source:{id:this.model.id,selector:this.getSelector(t.target),port:$(t.target).attr("port")},target:{x:e,y:i}}),this.paper.model.addCell(n),this._linkView=this.paper.findViewByModel(n),this._linkView.startArrowheadMove("target")}else this._dx=e,this._dy=i,joint.dia.CellView.prototype.pointerdown.apply(this,arguments)},pointermove:function(t,e,i){if(this._linkView)this._linkView.pointermove(t,e,i);else{var n=this.paper.options.gridSize,r=_.isFunction(this.options.interactive)?this.options.interactive(this,"pointermove"):this.options.interactive;if(r!==!1){var o=this.model.get("position");this.model.translate(g.snapToGrid(o.x,n)-o.x+g.snapToGrid(e-this._dx,n),g.snapToGrid(o.y,n)-o.y+g.snapToGrid(i-this._dy,n))}this._dx=g.snapToGrid(e,n),this._dy=g.snapToGrid(i,n),joint.dia.CellView.prototype.pointermove.apply(this,arguments)}},pointerup:function(t,e,i){this._linkView?(this._linkView.pointerup(t,e,i),delete this._linkView,this.model.trigger("batch:stop")):joint.dia.CellView.prototype.pointerup.apply(this,arguments)}}),"object"==typeof exports&&(module.exports.Element=joint.dia.Element,module.exports.ElementView=joint.dia.ElementView),"object"==typeof exports)var joint={dia:{Cell:require("./joint.dia.cell").Cell,CellView:require("./joint.dia.cell").CellView}},Backbone=require("backbone"),_=require("lodash"),g=require("./geometry");if(joint.dia.Link=joint.dia.Cell.extend({markup:['<path class="connection" stroke="black"/>','<path class="marker-source" fill="black" stroke="black" />','<path class="marker-target" fill="black" stroke="black" />','<path class="connection-wrap"/>','<g class="labels"/>','<g class="marker-vertices"/>','<g class="marker-arrowheads"/>','<g class="link-tools"/>'].join(""),labelMarkup:['<g class="label">',"<rect />","<text />","</g>"].join(""),toolMarkup:['<g class="link-tool">','<g class="tool-remove" event="remove">','<circle r="11" />','<path transform="scale(.8) translate(-16, -16)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z"/>',"<title>Remove link.</title>","</g>",'<g class="tool-options" event="link:options">','<circle r="11" transform="translate(25)"/>','<path fill="white" transform="scale(.55) translate(29, -16)" d="M31.229,17.736c0.064-0.571,0.104-1.148,0.104-1.736s-0.04-1.166-0.104-1.737l-4.377-1.557c-0.218-0.716-0.504-1.401-0.851-2.05l1.993-4.192c-0.725-0.91-1.549-1.734-2.458-2.459l-4.193,1.994c-0.647-0.347-1.334-0.632-2.049-0.849l-1.558-4.378C17.165,0.708,16.588,0.667,16,0.667s-1.166,0.041-1.737,0.105L12.707,5.15c-0.716,0.217-1.401,0.502-2.05,0.849L6.464,4.005C5.554,4.73,4.73,5.554,4.005,6.464l1.994,4.192c-0.347,0.648-0.632,1.334-0.849,2.05l-4.378,1.557C0.708,14.834,0.667,15.412,0.667,16s0.041,1.165,0.105,1.736l4.378,1.558c0.217,0.715,0.502,1.401,0.849,2.049l-1.994,4.193c0.725,0.909,1.549,1.733,2.459,2.458l4.192-1.993c0.648,0.347,1.334,0.633,2.05,0.851l1.557,4.377c0.571,0.064,1.148,0.104,1.737,0.104c0.588,0,1.165-0.04,1.736-0.104l1.558-4.377c0.715-0.218,1.399-0.504,2.049-0.851l4.193,1.993c0.909-0.725,1.733-1.549,2.458-2.458l-1.993-4.193c0.347-0.647,0.633-1.334,0.851-2.049L31.229,17.736zM16,20.871c-2.69,0-4.872-2.182-4.872-4.871c0-2.69,2.182-4.872,4.872-4.872c2.689,0,4.871,2.182,4.871,4.872C20.871,18.689,18.689,20.871,16,20.871z"/>',"<title>Link options.</title>","</g>","</g>"].join(""),vertexMarkup:['<g class="marker-vertex-group" transform="translate(<%= x %>, <%= y %>)">','<circle class="marker-vertex" idx="<%= idx %>" r="10" />','<path class="marker-vertex-remove-area" idx="<%= idx %>" d="M16,5.333c-7.732,0-14,4.701-14,10.5c0,1.982,0.741,3.833,2.016,5.414L2,25.667l5.613-1.441c2.339,1.317,5.237,2.107,8.387,2.107c7.732,0,14-4.701,14-10.5C30,10.034,23.732,5.333,16,5.333z" transform="translate(5, -33)"/>','<path class="marker-vertex-remove" idx="<%= idx %>" transform="scale(.8) translate(9.5, -37)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z">',"<title>Remove vertex.</title>","</path>","</g>"].join(""),arrowheadMarkup:['<g class="marker-arrowhead-group marker-arrowhead-group-<%= end %>">','<path class="marker-arrowhead" end="<%= end %>" d="M 26 0 L 0 13 L 26 26 z" />',"</g>"].join(""),defaults:{type:"link"},disconnect:function(){return this.set({source:g.point(0,0),target:g.point(0,0)})
},label:function(t,e){t=t||0;var i=this.get("labels")||[];if(0===arguments.length||1===arguments.length)return i[t];var n=_.merge({},i[t],e),r=i.slice();return r[t]=n,this.set({labels:r})},translate:function(t,e,i){var n={},r=this.get("source"),o=this.get("target"),s=this.get("vertices");return r.id||(n.source={x:r.x+t,y:r.y+e}),o.id||(n.target={x:o.x+t,y:o.y+e}),s&&s.length&&(n.vertices=_.map(s,function(i){return{x:i.x+t,y:i.y+e}})),this.set(n,i)}}),joint.dia.LinkView=joint.dia.CellView.extend({className:function(){return _.unique(this.model.get("type").split(".").concat("link")).join(" ")},options:{shortLinkLength:100},initialize:function(){joint.dia.CellView.prototype.initialize.apply(this,arguments),"function"!=typeof this.constructor.prototype.watchSource&&(this.constructor.prototype.watchSource=this._createWatcher("source"),this.constructor.prototype.watchTarget=this._createWatcher("target")),this._labelCache={},this._markerCache={},this.startListening()},startListening:function(){this.listenTo(this.model,"change:markup",this.render),this.listenTo(this.model,"change:smooth change:manhattan change:router change:connector",this.update),this.listenTo(this.model,"change:toolMarkup",function(){this.renderTools().updateToolsPosition()}),this.listenTo(this.model,"change:labels change:labelMarkup",function(){this.renderLabels().updateLabelPositions()}),this.listenTo(this.model,"change:vertices change:vertexMarkup",function(){this.renderVertexMarkers().update()}),this.listenTo(this.model,"change:source",function(t,e){this.watchSource(t,e).update()}),this.listenTo(this.model,"change:target",function(t,e){this.watchTarget(t,e).update()})},render:function(){this.$el.empty();var t=V(this.model.get("markup")||this.model.markup);if(_.isArray(t)||(t=[t]),this._V={},_.each(t,function(t){var e=t.attr("class");e&&(this._V[$.camelCase(e)]=t)},this),!this._V.connection)throw new Error("link: no connection path in the markup");return this.renderTools(),this.renderVertexMarkers(),this.renderArrowheadMarkers(),V(this.el).append(t),this.renderLabels(),this.watchSource(this.model,this.model.get("source")).watchTarget(this.model,this.model.get("target")).update(),this},renderLabels:function(){if(!this._V.labels)return this;this._labelCache={};var t=$(this._V.labels.node).empty(),e=this.model.get("labels")||[];if(!e.length)return this;var i=_.template(this.model.get("labelMarkup")||this.model.labelMarkup),n=V(i());return _.each(e,function(e,i){var r=n.clone().node;this._labelCache[i]=V(r);var o=$(r).find("text"),s=$(r).find("rect"),a=_.extend({"text-anchor":"middle","font-size":14},joint.util.getByPath(e,"attrs/text","/"));o.attr(_.omit(a,"text")),_.isUndefined(a.text)||V(o[0]).text(a.text+""),t.append(r);var h=V(o[0]).bbox(!0,t[0]);V(o[0]).translate(0,-h.height/2);var l=_.extend({fill:"white",rx:3,ry:3},joint.util.getByPath(e,"attrs/rect","/"));s.attr(_.extend(l,{x:h.x,y:h.y-h.height/2,width:h.width,height:h.height}))},this),this},renderTools:function(){if(!this._V.linkTools)return this;var t=$(this._V.linkTools.node).empty(),e=_.template(this.model.get("toolMarkup")||this.model.toolMarkup),i=V(e());return t.append(i.node),this._toolCache=i,this},renderVertexMarkers:function(){if(!this._V.markerVertices)return this;var t=$(this._V.markerVertices.node).empty(),e=_.template(this.model.get("vertexMarkup")||this.model.vertexMarkup);return _.each(this.model.get("vertices"),function(i,n){t.append(V(e(_.extend({idx:n},i))).node)}),this},renderArrowheadMarkers:function(){if(!this._V.markerArrowheads)return this;var t=$(this._V.markerArrowheads.node);t.empty();var e=_.template(this.model.get("arrowheadMarkup")||this.model.arrowheadMarkup);return this._V.sourceArrowhead=V(e({end:"source"})),this._V.targetArrowhead=V(e({end:"target"})),t.append(this._V.sourceArrowhead.node,this._V.targetArrowhead.node),this},update:function(){_.each(this.model.get("attrs"),function(t,e){_.isObject(t.filter)?(this.findBySelector(e).attr(_.omit(t,"filter")),this.applyFilter(e,t.filter)):this.findBySelector(e).attr(t)},this);var t=this.route=this.findRoute(this.model.get("vertices")||[]);this._findConnectionPoints(t);var e=this.getPathData(t);return this._V.connection.attr("d",e),this._V.connectionWrap&&this._V.connectionWrap.attr("d",e),this._translateAndAutoOrientArrows(this._V.markerSource,this._V.markerTarget),this.updateLabelPositions(),this.updateToolsPosition(),this.updateArrowheadMarkers(),delete this.options.perpendicular,this},_findConnectionPoints:function(t){var e,i,n,r,o=_.first(t);e=this.getConnectionPoint("source",this.model.get("source"),o||this.model.get("target")).round();var s=_.last(t);i=this.getConnectionPoint("target",this.model.get("target"),s||e).round();var a=this._markerCache;this._V.markerSource&&(a.sourceBBox=a.sourceBBox||this._V.markerSource.bbox(!0),n=g.point(e).move(o||i,a.sourceBBox.width*this._V.markerSource.scale().sx*-1).round()),this._V.markerTarget&&(a.targetBBox=a.targetBBox||this._V.markerTarget.bbox(!0),r=g.point(i).move(s||e,a.targetBBox.width*this._V.markerTarget.scale().sx*-1).round()),a.sourcePoint=n||e,a.targetPoint=r||i,this.sourcePoint=e,this.targetPoint=i},updateLabelPositions:function(){if(!this._V.labels)return this;var t=this.model.get("labels")||[];if(!t.length)return this;var e=this._V.connection.node,i=e.getTotalLength();return _.each(t,function(t,n){var r=t.position;r=r>i?i:r,r=0>r?i+r:r,r=r>1?r:i*r;var o=e.getPointAtLength(r);this._labelCache[n].attr("transform","translate("+o.x+", "+o.y+")")},this),this},updateToolsPosition:function(){if(!this._V.linkTools)return this;var t="",e=40;this.getConnectionLength()<this.options.shortLinkLength&&(t="scale(.5)",e/=2);var i=this.getPointAtLength(e);return this._toolCache.attr("transform","translate("+i.x+", "+i.y+") "+t),this},updateArrowheadMarkers:function(){if(!this._V.markerArrowheads)return this;if("none"===$.css(this._V.markerArrowheads.node,"display"))return this;var t=this.getConnectionLength()<this.options.shortLinkLength?.5:1;return this._V.sourceArrowhead.scale(t),this._V.targetArrowhead.scale(t),this._translateAndAutoOrientArrows(this._V.sourceArrowhead,this._V.targetArrowhead),this},_createWatcher:function(t){function e(e,i){i=i||{};var n=e.previous(t)||{},r=this["_"+t+"BBoxUpdate"];return this._isModel(n)&&this.stopListening(this.paper.getModelById(n.id),"change",r),this._isModel(i)&&this.listenTo(this.paper.getModelById(i.id),"change",r),_.bind(r,this)({cacheOnly:!0}),this}return e},_sourceBBoxUpdate:function(t){this.lastEndChange="source",t=t||{};var e=this.model.get("source");if(this._isModel(e)){var i=this._makeSelector(e),n=this.paper.findViewByModel(e.id),r=this.paper.viewport.querySelector(i);this.sourceBBox=n.getStrokeBBox(r),this.sourceView=n,this.sourceMagnet=r}else e&&(this.sourceBBox=g.rect(e.x,e.y,1,1));t.cacheOnly||this.update()},_targetBBoxUpdate:function(t){this.lastEndChange="target",t=t||{};var e=this.model.get("target");if(this._isModel(e)){var i=this._makeSelector(e),n=this.paper.findViewByModel(e.id),r=this.paper.viewport.querySelector(i);this.targetBBox=n.getStrokeBBox(r),this.targetView=n,this.targetMagnet=r}else e&&(this.targetBBox=g.rect(e.x,e.y,1,1));t.cacheOnly||this.update()},_translateAndAutoOrientArrows:function(t,e){t&&t.translateAndAutoOrient(this.sourcePoint,_.first(this.route)||this.targetPoint,this.paper.viewport),e&&e.translateAndAutoOrient(this.targetPoint,_.last(this.route)||this.sourcePoint,this.paper.viewport)},removeVertex:function(t){var e=_.clone(this.model.get("vertices"));return e&&e.length&&(e.splice(t,1),this.model.set("vertices",e)),this},addVertex:function(t){this.model.set("attrs",this.model.get("attrs")||{});for(var e,i=(this.model.get("attrs"),(this.model.get("vertices")||[]).slice()),n=i.slice(),r=this._V.connection.node.cloneNode(!1),o=r.getTotalLength(),s=20,a=i.length+1;a--&&(i.splice(a,0,t),V(r).attr("d",this.getPathData(this.findRoute(i))),e=r.getTotalLength(),e-o>s);)i=n.slice();return-1===a&&(a=0,i.splice(a,0,t)),this.model.set("vertices",i),a},sendToken:function(t,e,i){e=e||1e3,V(this.paper.viewport).append(t),V(t).animateAlongPath({dur:e+"ms",repeatCount:1},this._V.connection.node),_.delay(function(){V(t).remove(),i&&i()},e)},findRoute:function(t){var e=this.model.get("router");if(!e){if(!this.model.get("manhattan"))return t;e={name:"orthogonal"}}var i=joint.routers[e.name];if(!_.isFunction(i))throw"unknown router: "+e.name;var n=i.call(this,t||[],e.args||{},this);return n},getPathData:function(t){var e=this.model.get("connector");if(e||(e=this.model.get("smooth")?{name:"smooth"}:{name:"normal"}),!_.isFunction(joint.connectors[e.name]))throw"unknown connector: "+e.name;var i=joint.connectors[e.name].call(this,this._markerCache.sourcePoint,this._markerCache.targetPoint,t||this.model.get("vertices")||{},e.args||{},this);return i},getConnectionPoint:function(t,e,i){var n;if(e=e||{x:0,y:0},i=i||{x:0,y:0},this._isPoint(e))n=g.point(e);else{var r,o="source"===t?this.sourceBBox:this.targetBBox;if(this._isPoint(i))r=g.point(i);else{var s="source"===t?this.targetBBox:this.sourceBBox;r=g.rect(s).intersectionWithLineFromCenterToPoint(g.rect(o).center()),r=r||g.rect(s).center()}if(this.paper.options.perpendicularLinks||this.options.perpendicular){var a,h=g.rect(0,r.y,this.paper.options.width,1),l=g.rect(r.x,0,1,this.paper.options.height);if(h.intersect(g.rect(o)))switch(a=g.rect(o).sideNearestToPoint(r)){case"left":n=g.point(o.x,r.y);break;case"right":n=g.point(o.x+o.width,r.y);break;default:n=g.rect(o).center()}else if(l.intersect(g.rect(o)))switch(a=g.rect(o).sideNearestToPoint(r)){case"top":n=g.point(r.x,o.y);break;case"bottom":n=g.point(r.x,o.y+o.height);break;default:n=g.rect(o).center()}else n=g.rect(o).intersectionWithLineFromCenterToPoint(r),n=n||g.rect(o).center()}else if(this.paper.options.linkConnectionPoint){var u="target"===t?this.targetView:this.sourceView,c="target"===t?this.targetMagnet:this.sourceMagnet;n=this.paper.options.linkConnectionPoint(this,u,c,r)}else n=g.rect(o).intersectionWithLineFromCenterToPoint(r),n=n||g.rect(o).center()}return n},_isModel:function(t){return t&&t.id},_isPoint:function(t){return!this._isModel(t)},_makeSelector:function(t){var e='[model-id="'+t.id+'"]';return t.port?e+=' [port="'+t.port+'"]':t.selector&&(e+=" "+t.selector),e},getConnectionLength:function(){return this._V.connection.node.getTotalLength()},getPointAtLength:function(t){return this._V.connection.node.getPointAtLength(t)},_beforeArrowheadMove:function(){this.model.trigger("batch:start"),this._z=this.model.get("z"),this.model.set("z",Number.MAX_VALUE),this.el.style.pointerEvents="none",this.paper.options.markAvailable&&this._markAvailableMagnets()},_afterArrowheadMove:function(){this._z&&(this.model.set("z",this._z),delete this._z),this.el.style.pointerEvents="visiblePainted",this.paper.options.markAvailable&&this._unmarkAvailableMagnets(),this.model.trigger("batch:stop")},_createValidateConnectionArgs:function(t){function e(t,e){return i[o]=t,i[o+1]=t.el===e?void 0:e,i}var i=[];i[4]=t,i[5]=this;var n,r=0,o=0;"source"===t?(r=2,n="target"):(o=2,n="source");var s=this.model.get(n);return s.id&&(i[r]=this.paper.findViewByModel(s.id),i[r+1]=s.selector&&i[r].el.querySelector(s.selector)),e},_markAvailableMagnets:function(){var t=this.paper.model.getElements(),e=this.paper.options.validateConnection;_.chain(t).map(this.paper.findViewByModel,this.paper).each(function(t){var i="false"!==t.el.getAttribute("magnet")&&e.apply(this.paper,this._validateConnectionArgs(t,null)),n=_.filter(t.el.querySelectorAll("[magnet]"),function(i){return e.apply(this.paper,this._validateConnectionArgs(t,i))},this);i&&V(t.el).addClass("available-magnet"),_.each(n,function(t){V(t).addClass("available-magnet")}),(i||n.length)&&V(t.el).addClass("available-cell")},this)},_unmarkAvailableMagnets:function(){_.each(this.paper.el.querySelectorAll(".available-cell, .available-magnet"),function(t){V(t).removeClass("available-magnet").removeClass("available-cell")})},startArrowheadMove:function(t){this._action="arrowhead-move",this._arrowhead=t,this._validateConnectionArgs=this._createValidateConnectionArgs(this._arrowhead),this._beforeArrowheadMove()},pointerdown:function(t,e,i){function n(t){return _.isObject(r)&&r[t]===!1?!1:!0}joint.dia.CellView.prototype.pointerdown.apply(this,arguments),this._dx=e,this._dy=i;var r=_.isFunction(this.options.interactive)?this.options.interactive(this,"pointerdown"):this.options.interactive;if(r!==!1){var o=t.target.getAttribute("class");switch(o){case"marker-vertex":n("vertexMove")&&(this._action="vertex-move",this._vertexIdx=t.target.getAttribute("idx"));break;case"marker-vertex-remove":case"marker-vertex-remove-area":n("vertexRemove")&&this.removeVertex(t.target.getAttribute("idx"));break;case"marker-arrowhead":n("arrowheadMove")&&this.startArrowheadMove(t.target.getAttribute("end"));break;default:var s=t.target.parentNode.getAttribute("event");s?"remove"===s?this.model.remove():this.paper.trigger(s,t,this,e,i):n("vertexAdd")&&(this._vertexIdx=this.addVertex({x:e,y:i}),this._action="vertex-move")}this.paper.trigger("link:pointerdown",t,this,e,i)}},pointermove:function(t,e,i){switch(joint.dia.CellView.prototype.pointermove.apply(this,arguments),this._action){case"vertex-move":var n=_.clone(this.model.get("vertices"));n[this._vertexIdx]={x:e,y:i},this.model.set("vertices",n);break;case"arrowhead-move":if(this.paper.options.snapLinks){var r=this.paper.options.snapLinks.radius||50,o=this.paper.findViewsInArea({x:e-r,y:i-r,width:2*r,height:2*r});this._closestView&&this._closestView.unhighlight(this._closestEnd.selector),this._closestView=this._closestEnd=null;var s,a=g.point(e,i),h=Number.MAX_VALUE;_.each(o,function(t){"false"!==t.el.getAttribute("magnet")&&(s=t.model.getBBox().center().distance(a),r>s&&h>s&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(t,null))&&(h=s,this._closestView=t,this._closestEnd={id:t.model.id})),t.$("[magnet]").each(_.bind(function(e,i){var n=V(i).bbox(!1,this.paper.viewport);s=a.distance({x:n.x+n.width/2,y:n.y+n.height/2}),r>s&&h>s&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(t,i))&&(h=s,this._closestView=t,this._closestEnd={id:t.model.id,selector:t.getSelector(i),port:i.getAttribute("port")})},this))},this),this._closestView&&this._closestView.highlight(this._closestEnd.selector),this.model.set(this._arrowhead,this._closestEnd||{x:e,y:i})}else{var l="mousemove"===t.type?t.target:document.elementFromPoint(t.clientX,t.clientY);this._targetEvent!==l&&(this._magnetUnderPointer&&this._viewUnderPointer.unhighlight(this._magnetUnderPointer),this._viewUnderPointer=this.paper.findView(l),this._viewUnderPointer?(this._magnetUnderPointer=this._viewUnderPointer.findMagnet(l),this._magnetUnderPointer&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(this._viewUnderPointer,this._magnetUnderPointer))?this._magnetUnderPointer&&this._viewUnderPointer.highlight(this._magnetUnderPointer):this._magnetUnderPointer=null):this._magnetUnderPointer=null),this._targetEvent=l,this.model.set(this._arrowhead,{x:e,y:i})}}this._dx=e,this._dy=i},pointerup:function(){joint.dia.CellView.prototype.pointerup.apply(this,arguments),"arrowhead-move"===this._action&&(this.paper.options.snapLinks?(this._closestView&&this._closestView.unhighlight(this._closestEnd.selector),this._closestView=this._closestEnd=null):(this._magnetUnderPointer&&(this._viewUnderPointer.unhighlight(this._magnetUnderPointer),this.model.set(this._arrowhead,{id:this._viewUnderPointer.model.id,selector:this._viewUnderPointer.getSelector(this._magnetUnderPointer),port:$(this._magnetUnderPointer).attr("port")})),delete this._viewUnderPointer,delete this._magnetUnderPointer,delete this._staticView,delete this._staticMagnet),this._afterArrowheadMove()),delete this._action}}),"object"==typeof exports&&(module.exports.Link=joint.dia.Link,module.exports.LinkView=joint.dia.LinkView),joint.dia.Paper=Backbone.View.extend({className:"paper",options:{width:800,height:600,origin:{x:0,y:0},gridSize:50,perpendicularLinks:!1,elementView:joint.dia.ElementView,linkView:joint.dia.LinkView,snapLinks:!1,markAvailable:!1,defaultLink:new joint.dia.Link,validateMagnet:function(t,e){return"passive"!==e.getAttribute("magnet")},validateConnection:function(t,e,i,n,r){return("target"===r?i:t)instanceof joint.dia.ElementView}},events:{mousedown:"pointerdown",dblclick:"mousedblclick",click:"mouseclick",touchstart:"pointerdown",mousemove:"pointermove",touchmove:"pointermove"},constructor:function(t){this._configure(t),Backbone.View.apply(this,arguments)},_configure:function(t){this.options&&(t=_.extend({},_.result(this,"options"),t)),this.options=t},initialize:function(){_.bindAll(this,"addCell","sortCells","resetCells","pointerup","asyncRenderCells"),this.svg=V("svg").node,this.viewport=V("g").node,V(this.svg).append(V("defs").node),V(this.viewport).attr({"class":"viewport"}),V(this.svg).append(this.viewport),this.$el.append(this.svg),this.setOrigin(),this.setDimensions(),this.listenTo(this.model,"add",this.onAddCell),this.listenTo(this.model,"reset",this.resetCells),this.listenTo(this.model,"sort",this.sortCells),$(document).on("mouseup touchend",this.pointerup),this._mousemoved=!1},remove:function(){$(document).off("mouseup touchend",this.pointerup),Backbone.View.prototype.remove.call(this)},setDimensions:function(t,e){t=this.options.width=t||this.options.width,e=this.options.height=e||this.options.height,V(this.svg).attr({width:t,height:e}),this.trigger("resize",t,e)},setOrigin:function(t,e){this.options.origin.x=t||0,this.options.origin.y=e||0,V(this.viewport).translate(t,e,{absolute:!0}),this.trigger("translate",t,e)},fitToContent:function(t,e,i,n){_.isObject(t)?(n=t,t=n.gridWidth||1,e=n.gridHeight||1,i=n.padding||0):(n=n||{},t=t||1,e=e||1,i=i||0);var r=V(this.viewport).bbox(!0,this.svg),o=V(this.viewport).scale();r.x*=o.sx,r.y*=o.sy,r.width*=o.sx,r.height*=o.sy;var s=Math.max(Math.ceil((r.width+r.x)/t),1)*t,a=Math.max(Math.ceil((r.height+r.y)/e),1)*e,h=0,l=0;("negative"==n.allowNewOrigin&&r.x<0||"positive"==n.allowNewOrigin&&r.x>=0||"any"==n.allowNewOrigin)&&(h=Math.ceil(-r.x/t)*t,h+=i,s+=h),("negative"==n.allowNewOrigin&&r.y<0||"positive"==n.allowNewOrigin&&r.y>=0||"any"==n.allowNewOrigin)&&(l=Math.ceil(-r.y/e)*e,l+=i,a+=l),s+=i,a+=i;var u=s!=this.options.width||a!=this.options.height,c=h!=this.options.origin.x||l!=this.options.origin.y;c&&this.setOrigin(h,l),u&&this.setDimensions(s,a)},scaleContentToFit:function(t){var e=this.getContentBBox();if(e.width&&e.height){t=t||{},_.defaults(t,{padding:0,preserveAspectRatio:!0,scaleGrid:null,minScale:0,maxScale:Number.MAX_VALUE});var i=t.padding,n=t.minScaleX||t.minScale,r=t.maxScaleX||t.maxScale,o=t.minScaleY||t.minScale,s=t.maxScaleY||t.maxScale,a=t.fittingBBox||{x:this.options.origin.x,y:this.options.origin.y,width:this.options.width,height:this.options.height};a=g.rect(a).moveAndExpand({x:i,y:i,width:-2*i,height:-2*i});var h=V(this.viewport).scale(),l=a.width/e.width*h.sx,u=a.height/e.height*h.sy;if(t.preserveAspectRatio&&(l=u=Math.min(l,u)),t.scaleGrid){var c=t.scaleGrid;l=c*Math.floor(l/c),u=c*Math.floor(u/c)}l=Math.min(r,Math.max(n,l)),u=Math.min(s,Math.max(o,u)),this.scale(l,u);var f=this.getContentBBox(),d=a.x-f.x,p=a.y-f.y;this.setOrigin(d,p)}},getContentBBox:function(){var t=this.viewport.getBoundingClientRect(),e=this.viewport.getScreenCTM(),i=this.viewport.getCTM(),n=g.rect({x:t.left-e.e+i.e,y:t.top-e.f+i.f,width:t.width,height:t.height});return n},createViewForModel:function(t){var e,i=t.get("type"),n=i.split(".")[0],r=i.split(".")[1];return e=joint.shapes[n]&&joint.shapes[n][r+"View"]?new joint.shapes[n][r+"View"]({model:t,interactive:this.options.interactive}):t instanceof joint.dia.Element?new this.options.elementView({model:t,interactive:this.options.interactive}):new this.options.linkView({model:t,interactive:this.options.interactive})},onAddCell:function(t,e,i){if(this.options.async&&i.async!==!1&&_.isNumber(i.position)){if(this._asyncCells=this._asyncCells||[],this._asyncCells.push(t),0==i.position){if(this._frameId)throw"another asynchronous rendering in progress";this.asyncRenderCells(this._asyncCells),delete this._asyncCells}}else this.addCell(t)},addCell:function(t){var e=this.createViewForModel(t);V(this.viewport).append(e.el),e.paper=this,e.render(),$(e.el).find("image").on("dragstart",function(){return!1})},resetCells:function(t){$(this.viewport).empty();var e=t.models.slice();e.sort(function(t){return t instanceof joint.dia.Link?1:-1}),this._frameId&&(joint.util.cancelFrame(this._frameId),delete this._frameId),this.options.async?this.asyncRenderCells(e):(_.each(e,this.addCell,this),this.sortCells())},asyncRenderCells:function(t){var e=!1;this._frameId&&_.each(_.range(this.options.async&&this.options.async.batchSize||50),function(){var i=t.shift();e=!i,e||this.addCell(i)},this),e?(delete this._frameId,this.sortCells(),this.trigger("render:done")):this._frameId=joint.util.nextFrame(_.bind(function(){this.asyncRenderCells(t)},this))},sortCells:function(){var t=$(this.viewport).children("[model-id]"),e=this.model.get("cells");this.sortElements(t,function(t,i){var n=e.get($(t).attr("model-id")),r=e.get($(i).attr("model-id"));return(n.get("z")||0)>(r.get("z")||0)?1:-1})},sortElements:function(t,e){var i=$(t),n=i.map(function(){var t=this,e=t.parentNode,i=e.insertBefore(document.createTextNode(""),t.nextSibling);return function(){if(e===this)throw new Error("You can't sort elements if any one is a descendant of another.");e.insertBefore(this,i),e.removeChild(i)}});return Array.prototype.sort.call(i,e).each(function(t){n[t].call(this)})},scale:function(t,e,i,n){e=e||t,_.isUndefined(i)&&(i=0,n=0),V(this.viewport).attr("transform","");var r=this.options.origin.x,o=this.options.origin.y;if(i||n||r||o){var s=r-i*(t-1),a=o-n*(e-1);this.setOrigin(s,a)}return V(this.viewport).scale(t,e),this.trigger("scale",t,e,i,n),this},rotate:function(t,e,i){if(_.isUndefined(e)){var n=this.viewport.getBBox();e=n.width/2,i=n.height/2}V(this.viewport).rotate(t,e,i)},findView:function(t){var e=this.$(t);return 0===e.length||e[0]===this.el?void 0:e.data("view")?e.data("view"):this.findView(e.parent())},findViewByModel:function(t){var e=_.isString(t)?t:t.id,i=this.$('[model-id="'+e+'"]');return i.length?i.data("view"):void 0},findViewsFromPoint:function(t){t=g.point(t);var e=_.map(this.model.getElements(),this.findViewByModel);return _.filter(e,function(e){return g.rect(V(e.el).bbox(!1,this.viewport)).containsPoint(t)},this)},findViewsInArea:function(t){t=g.rect(t);var e=_.map(this.model.getElements(),this.findViewByModel);return _.filter(e,function(e){return t.intersect(g.rect(V(e.el).bbox(!1,this.viewport)))},this)},getModelById:function(t){return this.model.getCell(t)},snapToGrid:function(t){var e=V(this.viewport).toLocalPoint(t.x,t.y);return{x:g.snapToGrid(e.x,this.options.gridSize),y:g.snapToGrid(e.y,this.options.gridSize)}},getDefaultLink:function(t,e){return _.isFunction(this.options.defaultLink)?this.options.defaultLink.call(this,t,e):this.options.defaultLink.clone()},mousedblclick:function(t){t.preventDefault(),t=joint.util.normalizeEvent(t);var e=this.findView(t.target),i=this.snapToGrid({x:t.clientX,y:t.clientY});e?e.pointerdblclick(t,i.x,i.y):this.trigger("blank:pointerdblclick",t,i.x,i.y)},mouseclick:function(t){if(!this._mousemoved){t=joint.util.normalizeEvent(t);var e=this.findView(t.target),i=this.snapToGrid({x:t.clientX,y:t.clientY});e?e.pointerclick(t,i.x,i.y):this.trigger("blank:pointerclick",t,i.x,i.y)}this._mousemoved=!1},pointerdown:function(t){t=joint.util.normalizeEvent(t);var e=this.findView(t.target),i=this.snapToGrid({x:t.clientX,y:t.clientY});e?(this.sourceView=e,e.pointerdown(t,i.x,i.y)):this.trigger("blank:pointerdown",t,i.x,i.y)},pointermove:function(t){if(t.preventDefault(),t=joint.util.normalizeEvent(t),this.sourceView){this._mousemoved=!0;var e=this.snapToGrid({x:t.clientX,y:t.clientY});this.sourceView.pointermove(t,e.x,e.y)}},pointerup:function(t){t=joint.util.normalizeEvent(t);var e=this.snapToGrid({x:t.clientX,y:t.clientY});this.sourceView?(this.sourceView.pointerup(t,e.x,e.y),this.sourceView=null):this.trigger("blank:pointerup",t,e.x,e.y)}}),"object"==typeof exports)var joint={util:require("../src/core").util,shapes:{},dia:{Element:require("../src/joint.dia.element").Element,ElementView:require("../src/joint.dia.element").ElementView}},_=require("lodash");joint.shapes.basic={},joint.shapes.basic.Generic=joint.dia.Element.extend({defaults:joint.util.deepSupplement({type:"basic.Generic",attrs:{".":{fill:"#FFFFFF",stroke:"none"}}},joint.dia.Element.prototype.defaults)}),joint.shapes.basic.Rect=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><rect/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Rect",attrs:{rect:{fill:"#FFFFFF",stroke:"black",width:100,height:60},text:{"font-size":14,text:"","ref-x":.5,"ref-y":.5,ref:"rect","y-alignment":"middle","x-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Text=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><text/></g></g>',defaults:joint.util.deepSupplement({type:"basic.Text",attrs:{text:{"font-size":18,fill:"black"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Circle=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><circle/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Circle",size:{width:60,height:60},attrs:{circle:{fill:"#FFFFFF",stroke:"black",r:30,transform:"translate(30, 30)"},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":.5,"ref-y":.5,ref:"circle","y-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Image=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><image/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Image",attrs:{text:{"font-size":14,text:"","text-anchor":"middle","ref-x":.5,"ref-dy":20,ref:"image","y-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Path=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><path/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Path",size:{width:60,height:60},attrs:{path:{fill:"#FFFFFF",stroke:"black"},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":.5,"ref-dy":20,ref:"path","y-alignment":"middle",fill:"black","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Rhombus=joint.shapes.basic.Path.extend({defaults:joint.util.deepSupplement({type:"basic.Rhombus",attrs:{path:{d:"M 30 0 L 60 30 30 60 0 30 z"},text:{"ref-y":.5}}},joint.shapes.basic.Path.prototype.defaults)}),joint.shapes.basic.PortsModelInterface={initialize:function(){this.updatePortsAttrs(),this.on("change:inPorts change:outPorts",this.updatePortsAttrs,this),this.constructor.__super__.constructor.__super__.initialize.apply(this,arguments)},updatePortsAttrs:function(){var t=this.get("attrs");_.each(this._portSelectors,function(e){t[e]&&delete t[e]}),this._portSelectors=[];var e={};_.each(this.get("inPorts"),function(t,i,n){var r=this.getPortAttrs(t,i,n.length,".inPorts","in");this._portSelectors=this._portSelectors.concat(_.keys(r)),_.extend(e,r)},this),_.each(this.get("outPorts"),function(t,i,n){var r=this.getPortAttrs(t,i,n.length,".outPorts","out");this._portSelectors=this._portSelectors.concat(_.keys(r)),_.extend(e,r)},this),this.attr(e,{silent:!0}),this.processPorts(),this.trigger("process:ports")},getPortSelector:function(t){var e=".inPorts",i=this.get("inPorts").indexOf(t);if(0>i&&(e=".outPorts",i=this.get("outPorts").indexOf(t),0>i))throw new Error("getPortSelector(): Port doesn't exist.");return e+">g:nth-child("+(i+1)+")>circle"}},joint.shapes.basic.PortsViewInterface={initialize:function(){this.listenTo(this.model,"process:ports",this.update),joint.dia.ElementView.prototype.initialize.apply(this,arguments)},update:function(){this.renderPorts(),joint.dia.ElementView.prototype.update.apply(this,arguments)},renderPorts:function(){var t=this.$(".inPorts").empty(),e=this.$(".outPorts").empty(),i=_.template(this.model.portMarkup);_.each(_.filter(this.model.ports,function(t){return"in"===t.type}),function(e,n){t.append(V(i({id:n,port:e})).node)}),_.each(_.filter(this.model.ports,function(t){return"out"===t.type}),function(t,n){e.append(V(i({id:n,port:t})).node)})}},joint.shapes.basic.TextBlock=joint.shapes.basic.Generic.extend({markup:['<g class="rotatable"><g class="scalable"><rect/></g><switch>','<foreignObject requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" class="fobj">','<body xmlns="http://www.w3.org/1999/xhtml"><div/></body>',"</foreignObject>",'<text class="content"/>',"</switch></g>"].join(""),defaults:joint.util.deepSupplement({type:"basic.TextBlock",attrs:{rect:{fill:"#ffffff",stroke:"#000000",width:80,height:100},text:{fill:"#000000","font-size":14,"font-family":"Arial, helvetica, sans-serif"},".content":{text:"",ref:"rect","ref-x":.5,"ref-y":.5,"y-alignment":"middle","x-alignment":"middle"}},content:""},joint.shapes.basic.Generic.prototype.defaults),initialize:function(){"undefined"!=typeof SVGForeignObjectElement&&(this.setForeignObjectSize(this,this.get("size")),this.setDivContent(this,this.get("content")),this.listenTo(this,"change:size",this.setForeignObjectSize),this.listenTo(this,"change:content",this.setDivContent)),joint.shapes.basic.Generic.prototype.initialize.apply(this,arguments)},setForeignObjectSize:function(t,e){t.attr({".fobj":_.clone(e),div:{style:_.clone(e)}})},setDivContent:function(t,e){t.attr({div:{html:e}})}}),joint.shapes.basic.TextBlockView=joint.dia.ElementView.extend({initialize:function(){joint.dia.ElementView.prototype.initialize.apply(this,arguments),"undefined"==typeof SVGForeignObjectElement&&(this.noSVGForeignObjectElement=!0,this.listenTo(this.model,"change:content",function(t){this.updateContent(t)}))},update:function(t,e){if(this.noSVGForeignObjectElement){var i=this.model,n=_.omit(e||i.get("attrs"),".content");joint.dia.ElementView.prototype.update.call(this,i,n),(!e||_.has(e,".content"))&&this.updateContent(i,e)}else joint.dia.ElementView.prototype.update.call(this,i,e)},updateContent:function(t,e){var i=_.merge({},(e||t.get("attrs"))[".content"]);delete i.text;var n=joint.util.breakText(t.get("content"),t.get("size"),i,{svgDocument:this.paper.svg}),r=joint.util.setByPath({},".content",i,"/");r[".content"].text=n,joint.dia.ElementView.prototype.update.call(this,t,r)}}),"object"==typeof exports&&(module.exports=joint.shapes.basic),joint.routers.orthogonal=function(){function t(t,e){return t.y<e.y&&t.x===e.x?"down":t.y>e.y&&t.x===e.x?"up":t.x<e.x&&t.y===e.y?"right":"left"}function e(t,e,i){var n;if(n=t.x<e.x?t.y>e.y?["up","right"]:t.y<e.y?["down","right"]:["right"]:t.x>e.x?t.y>e.y?["up","left"]:t.y<e.y?["down","left"]:["left"]:t.y>e.y?["up"]:["down"],_.contains(n,i))return i;var r=_.first(n);switch(i){case"down":if("up"===r)return _.last(n);break;case"up":if("down"===r)return _.last(n);break;case"left":if("right"===r)return _.last(n);break;case"right":if("left"===r)return _.last(n)}return r}function i(t,i,n){var r=e(t,i,n);return"down"===r||"up"===r?{x:t.x,y:i.y,d:r}:{x:i.x,y:t.y,d:r}}function n(e){e=(e||[]).slice();var n=[],s=r.center(),a=o.center();e.length||(Math.abs(s.x-a.x)<r.width/2||Math.abs(s.y-a.y)<r.height/2)&&(e=[{x:Math.min(s.x,a.x)+Math.abs(s.x-a.x)/2,y:Math.min(s.y,a.y)+Math.abs(s.y-a.y)/2}]),e.unshift(s),e.push(a);for(var h,l,u,c,f=0;f<e.length-1;f++){u=e[f],c=e[f+1],l=_.last(n),f>0&&(h=u,h.d=l?t(l,u):"top",n.push(h),l=h);var d=l&&l.d;h=i(u,c,d),g.point(h).equals(g.point(u))||g.point(h).equals(g.point(c))||n.push(h)
}return n}var r,o;return function(t){return r=this.sourceBBox,o=this.targetBBox,n(t)}}(),joint.routers.manhattan=function(){"use strict";function t(t,e){for(var i,n=[],r={x:0,y:0},o=e;i=t[o];){var s=i.difference(o);s.equals(r)||(n.unshift(o),r=s),o=i}return n.unshift(o),n}function e(t,e,i){var n=i.step,r=t.center(),o=_.chain(i.directionMap).pick(e).map(function(e){var i=e.x*t.width/2,o=e.y*t.height/2,s=g.point(r).offset(i,o).snapToGrid(n);return t.containsPoint(s)&&s.offset(e.x*n,e.y*n),s}).value();return o}function i(t,e,i){var n=360/i,r=Math.floor(t.theta(e)/n);return i-r}function n(n,r,o,s){var a=s.reversed?s.endDirections:s.startDirections,h=s.reversed?s.startDirections:s.endDirections,l=n instanceof g.rect?e(n,a,s):[n],u=r instanceof g.rect?e(r,h,s):[r],c=l.length>1?n.center():l[0],f=u.length>1?r.center():u[0],d=_.filter(u,function(t){var e=g.point(t).snapToGrid(s.mapGridSize).toString(),i=_.every(o[e],function(e){return!e.containsPoint(t)});return i});if(d.length)for(var p=s.step,m=s.penalties,v=_.chain(d).invoke("snapToGrid",p).min(function(t){return s.estimateCost(c,t)}).value(),y={},x={},b={},w=s.directions,k=w.length,j=k/2,C=s.previousDirIndexes||{},V={},M={},A=_.chain(l).invoke("snapToGrid",p).each(function(t){var e=t.toString();x[e]=0,b[e]=s.estimateCost(t,v),C[e]=C[e]||i(c,t,k),M[e]=!0}).map(function(t){return t.toString()}).sortBy(function(t){return b[t]}).value(),S=s.maximumLoops,T=s.maxAllowedDirectionChange;A.length&&S--;){var P=A[0],E=g.point(P);if(v.equals(E))return s.previousDirIndexes=_.pick(C,P),t(y,E);A.splice(0,1),M[N]=null,V[N]=!0;for(var B=C[P],F=x[P],$=0;k>$;$++){var L=Math.abs($-B);if(L>j&&(L=k-L),!(L>T)){var z=w[$],O=g.point(E).offset(z.offsetX,z.offsetY),N=O.toString();if(!V[N]){var I=g.point(O).snapToGrid(s.mapGridSize).toString(),R=_.every(o[I],function(t){return!t.containsPoint(O)});if(R){var G=_.has(M,N),q=F+z.cost;if((!G||q<x[N])&&(y[N]=E,C[N]=$,x[N]=q,b[N]=q+s.estimateCost(O,v)+m[L],!G)){var U=_.sortedIndex(A,N,function(t){return b[t]});A.splice(U,0,N),M[N]=!0}}}}}}return s.fallbackRoute(c,f,s)}function r(t,e){e.directions=_.result(e,"directions"),e.penalties=_.result(e,"penalties"),e.paddingBox=_.result(e,"paddingBox"),this.options.perpendicular=!!e.perpendicular;var i=e.reversed="source"===this.lastEndChange,r=g.rect(i?this.targetBBox:this.sourceBBox),o=g.rect(i?this.sourceBBox:this.targetBBox);r.moveAndExpand(e.paddingBox),o.moveAndExpand(e.paddingBox);for(var s=this.model,a=this.paper.model,h=_.chain(e.excludeEnds).map(s.get,s).pluck("id").map(a.getCell,a).value(),l=e.mapGridSize,u=_.chain(a.getElements()).difference(h).reject(function(t){return _.contains(e.excludeTypes,t.get("type"))}).invoke("getBBox").invoke("moveAndExpand",e.paddingBox).foldl(function(t,e){for(var i=e.origin().snapToGrid(l),n=e.corner().snapToGrid(l),r=i.x;r<=n.x;r+=l)for(var o=i.y;o<=n.y;o+=l){var s=r+"@"+o;t[s]=t[s]||[],t[s].push(e)}return t},{}).value(),c=[],f=_.map(t,g.point),d=r.center(),p=0,m=f.length;m>=p;p++){var v=null,y=x||r,x=f[p];if(!x){x=o;var b=!this.model.get("source").id||!this.model.get("target").id;if(b&&_.isFunction(e.draggingRoute)){var w=y instanceof g.rect?y.center():y;v=e.draggingRoute(w,x.origin(),e)}}v=v||n(y,x,u,e);var k=_.first(v);k&&k.equals(d)&&v.shift(),d=_.last(v)||d,c=c.concat(v)}return i?c.reverse():c}var o={step:10,perpendicular:!0,mapGridSize:100,excludeEnds:[],excludeTypes:["basic.Text"],maximumLoops:500,startDirections:["left","right","top","bottom"],endDirections:["left","right","top","bottom"],directionMap:{right:{x:1,y:0},bottom:{x:0,y:1},left:{x:-1,y:0},top:{x:0,y:-1}},maxAllowedDirectionChange:1,paddingBox:function(){var t=this.step;return{x:-t,y:-t,width:2*t,height:2*t}},directions:function(){var t=this.step;return[{offsetX:t,offsetY:0,cost:t},{offsetX:0,offsetY:t,cost:t},{offsetX:-t,offsetY:0,cost:t},{offsetX:0,offsetY:-t,cost:t}]},penalties:function(){return[0,this.step/2,this.step]},estimateCost:function(t,e){return t.manhattanDistance(e)},fallbackRoute:function(t,e,i){var n=i.prevDirIndexes||{},r=(n[t]||0)%2?g.point(t.x,e.y):g.point(e.x,t.y);return[r,e]},draggingRoute:null};return function(t,e,i){return r.call(i,t,_.extend({},o,e))}}(),joint.routers.metro=function(){if(!_.isFunction(joint.routers.manhattan))throw"Metro requires the manhattan router.";var t={diagonalCost:null,directions:function(){var t=this.step,e=this.diagonalCost||Math.ceil(Math.sqrt(t*t<<1));return[{offsetX:t,offsetY:0,cost:t},{offsetX:t,offsetY:t,cost:e},{offsetX:0,offsetY:t,cost:t},{offsetX:-t,offsetY:t,cost:e},{offsetX:-t,offsetY:0,cost:t},{offsetX:-t,offsetY:-t,cost:e},{offsetX:0,offsetY:-t,cost:t},{offsetX:t,offsetY:-t,cost:e}]},fallbackRoute:function(t,e){var i=t.theta(e),n={x:e.x,y:t.y},r={x:t.x,y:e.y};if(i%180>90){var o=n;n=r,r=o}var s=45>i%90?n:r,a=g.line(t,s),h=90*Math.ceil(i/90),l=g.point.fromPolar(a.squaredLength(),g.toRad(h+135),s),u=g.line(e,l),c=a.intersection(u);return c?[c.round(),e]:[e]}};return function(e,i,n){return joint.routers.manhattan(e,_.extend({},t,i),n)}}(),joint.connectors.normal=function(t,e,i){var n=["M",t.x,t.y];return _.each(i,function(t){n.push(t.x,t.y)}),n.push(e.x,e.y),n.join(" ")},joint.connectors.rounded=function(t,e,i,n){var r,o,s,a,h,l,u=n.radius||10,c=["M",t.x,t.y];return _.each(i,function(n,f){h=i[f-1]||t,l=i[f+1]||e,s=a||g.point(n).distance(h)/2,a=g.point(n).distance(l)/2,r=g.point(n).move(h,-Math.min(u,s)).round(),o=g.point(n).move(l,-Math.min(u,a)).round(),c.push(r.x,r.y,"S",n.x,n.y,o.x,o.y,"L")}),c.push(e.x,e.y),c.join(" ")},joint.connectors.smooth=function(t,e,i){var n;if(i.length)n=g.bezier.curveThroughPoints([t].concat(i).concat([e]));else{var r=t.x<e.x?e.x-(e.x-t.x)/2:t.x-(t.x-e.x)/2;n=["M",t.x,t.y,"C",r,t.y,r,e.y,e.x,e.y]}return n.join(" ")};